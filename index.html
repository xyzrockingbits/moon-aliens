<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ—É–Ω–Ω—ã–µ –ü—Ä–∏—à–µ–ª—å—Ü—ã v12.0 (Angry)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            if (msg.indexOf("ResizeObserver") !== -1) return;
            var box = document.createElement('div');
            box.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:blue;color:white;z-index:99999;padding:20px;font-family:monospace;font-size:14px;box-sizing:border-box;overflow:auto;';
            box.innerHTML = '<h1>üíÄ –û–®–ò–ë–ö–ê!</h1><p>' + msg + '</p><p>–°—Ç—Ä–æ–∫–∞: ' + line + '</p><button onclick="this.parentElement.remove()" style="padding:10px;font-size:20px;margin-top:20px;color:black">–ó–ê–ö–†–´–¢–¨</button>';
            document.body.appendChild(box);
            return false;
        };
    </script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #0b0d17; font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif; touch-action: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        #gameCanvas { display: block; width: 100vw; height: 100vh; touch-action: none; }
        #debug-bar { position: absolute; top: 0; left: 0; width: 100%; background: rgba(50, 50, 50, 0.9); color: #00ff00; font-size: 10px; padding: 2px; z-index: 10000; text-align: center; border-bottom: 1px solid #00ff00; pointer-events: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: none; z-index: 10; }
        .screen { pointer-events: auto; background: rgba(11, 13, 23, 0.95); padding: 20px; border-radius: 20px; text-align: center; border: 4px solid #4ade80; box-shadow: 0 0 20px #4ade80; max-width: 90%; width: 400px; max-height: 90vh; overflow-y: auto; transition: all 0.3s ease; }
        h1 { color: #fff; margin: 0 0 20px 0; font-size: 26px; }
        p { color: #ccc; font-size: 16px; line-height: 1.4; }
        .btn { background: #4ade80; color: #000; border: none; padding: 12px 24px; font-size: 18px; border-radius: 50px; cursor: pointer; font-weight: bold; margin: 8px auto; display: block; width: 80%; touch-action: manipulation; }
        .btn:active { transform: scale(0.95); }
        .btn-ai { background: linear-gradient(45deg, #a78bfa, #f472b6); color: white; box-shadow: 0 0 10px #a78bfa; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .btn-option { background: #334155; color: white; text-align: left; font-size: 16px; padding: 12px 15px; width: 100%; box-sizing: border-box; margin: 6px 0; border: 2px solid #4ade80; border-radius: 12px; }
        .btn-settings { position: absolute; top: 30px; right: 20px; background: none; border: none; font-size: 30px; cursor: pointer; pointer-events: auto; z-index: 50; }
        input[type="text"] { padding: 12px; border-radius: 12px; border: 2px solid #4ade80; background: #222; color: white; font-size: 18px; width: 85%; margin-bottom: 15px; text-align: center; display: block; margin-left: auto; margin-right: auto; }
        .ai-response-box { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 12px; margin: 15px 0; min-height: 60px; color: #bef264; font-style: italic; white-space: pre-wrap; font-size: 16px; }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; text-align: left; max-height: 250px; overflow-y: auto; }
        .leaderboard-item { background: rgba(255,255,255,0.1); margin-bottom: 6px; padding: 8px 12px; border-radius: 8px; display: flex; justify-content: space-between; color: white; font-size: 16px; }
        .medal { margin-right: 8px; } .score-num { font-weight: bold; color: #fcd34d; }
        #qrcode-container { background: white; padding: 15px; border-radius: 10px; display: inline-block; margin: 15px 0; }
        .loading { animation: pulse 1.5s infinite; } @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 10px; box-sizing: border-box; }
        #score-board { position: absolute; top: 25px; left: 10px; color: white; font-size: 20px; font-weight: bold; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 15px; border: 2px solid #4ade80; display: flex; flex-direction: column; align-items: flex-start; z-index: 20; }
        #combo-display { font-size: 16px; color: #fcd34d; margin-top: 2px; opacity: 0; transition: opacity 0.2s; }
        #lives-container { position: absolute; top: 25px; right: 10px; font-size: 24px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 15px; border: 2px solid #ef4444; letter-spacing: 2px; z-index: 20; }
        #danger-bar { position: absolute; bottom: 0; left: 0; height: 6px; background: linear-gradient(90deg, #4ade80, #fcd34d, #ef4444); width: 0%; transition: width 0.5s linear; z-index: 4; }
        #damage-flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; transition: opacity 0.1s; z-index: 30; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="debug-bar">Ver 12.0 (Angry) | –ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="damage-flash"></div>
    <div id="danger-bar"></div>
    <div id="game-ui" class="hidden"><div id="score-board"><span>–û—á–∫–∏: <span id="score-val">0</span></span><div id="combo-display">COMBO x2!</div></div><div id="lives-container">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div>

    <div id="ui-layer">
        <button class="btn-settings" onclick="showScreen('settings-screen')">‚öôÔ∏è</button>
        <div id="start-screen" class="screen">
            <h1>üëΩ –õ—É–Ω–Ω—ã–µ –ü—Ä–∏—à–µ–ª—å—Ü—ã üåë</h1>
            <input type="text" id="player-name" placeholder="–ò–º—è –∫–æ—Å–º–æ–Ω–∞–≤—Ç–∞" maxlength="12">
            <p style="font-size: 18px; margin-top: 10px; color: #bef264;">–õ–æ–≤–∏ –¥–æ–±—Ä—è–∫–æ–≤ —Å ‚ù§Ô∏è!<br>–ë–µ—Ä–µ–≥–∏—Å—å –∑–ª—é–∫ —Å ‚ùå!</p>
            <button class="btn" onclick="startGame()">üöÄ –ü–û–õ–ï–¢–ï–õ–ò!</button>
            <button class="btn" style="background: #fcd34d" onclick="showLeaderboard()">üèÜ –†–ï–ö–û–†–î–´</button>
            <div style="display:flex; justify-content: center; gap: 5px; margin-top: 5px;">
                <button class="btn btn-ai" style="padding: 10px; font-size: 14px;" onclick="nextQuizQuestion()">üéì –ö–≤–∏–∑</button>
                <button class="btn btn-ai" style="padding: 10px; font-size: 14px;" onclick="showScreen('crossword-screen')">üß© –ó–∞–≥–∞–¥–∫–∏</button>
                <button class="btn btn-ai" style="padding: 10px; font-size: 14px;" onclick="showScreen('cafe-screen')">‚òï –ö–∞—Ñ–µ</button>
            </div>
        </div>
        <div id="settings-screen" class="screen hidden">
            <h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
            <p style="font-size: 14px;">1. –í—Å—Ç–∞–≤—å API –∫–ª—é—á:</p>
            <input type="text" id="api-key-input" placeholder="–ö–ª—é—á AIza..." style="font-size: 14px;">
            <button class="btn" onclick="saveApiKey()">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
            <hr style="border-color: #4ade80; opacity: 0.3; margin: 15px 0;">
            <p style="font-size: 14px;">2. –ü–æ–¥–µ–ª–∏—Å—å –∏–≥—Ä–æ–π:</p>
            <button class="btn" style="background: white; color: black;" onclick="generateGameQR()">üì± –ü–û–ö–ê–ó–ê–¢–¨ QR</button>
            <div id="qrcode-container" class="hidden"><div id="qrcode"></div><p style="color:black; font-size: 12px; margin: 0;">–°–∫–∞–Ω–∏—Ä—É–π!</p></div>
            <button class="btn" style="background:#ccc; margin-top: 20px;" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
            <p id="key-status" style="font-size: 12px; margin-top: 10px;"></p>
        </div>
        <div id="leaderboard-screen" class="screen hidden">
            <h1>üèÜ –ó–∞–ª –°–ª–∞–≤—ã</h1>
            <p id="leaderboard-status" style="font-size: 12px; color: #aaa;">...</p>
            <ul id="leaderboard-list" class="leaderboard-list"></ul>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
        </div>
        <div id="game-over-screen" class="screen hidden">
            <h1 style="color: #ff4d4d">–ö–û–ù–ï–¶ üíÄ</h1>
            <p id="game-over-msg">–ñ–∏–∑–Ω–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å!</p>
            <p style="font-size: 22px; color: #fcd34d;">–°—á–µ—Ç: <span id="final-score">0</span></p>
            <div id="new-record-msg" class="hidden" style="color: #4ade80; font-weight: bold; margin-bottom: 10px;">üéâ –†–ï–ö–û–†–î! üéâ</div>
            <button class="btn" onclick="startGame()">–ï–©–Å –†–ê–ó</button>
            <button class="btn" style="background: #fcd34d" onclick="showLeaderboard()">üèÜ –¢–ê–ë–õ–ò–¶–ê</button>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ú–ï–ù–Æ</button>
        </div>
        <div id="quiz-screen" class="screen hidden"><h1>üéì –ö–≤–∏–∑</h1><div id="quiz-loading"><p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div><div id="quiz-content" class="hidden"><p id="quiz-question" style="font-weight: bold; color: white;"></p><div id="quiz-options"></div><p id="quiz-feedback"></p></div><button id="btn-next-quiz" class="btn btn-ai hidden" onclick="nextQuizQuestion()">–î–ê–õ–¨–®–ï</button><button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button></div>
        <div id="crossword-screen" class="screen hidden"><h1>üß© –ó–∞–≥–∞–¥–∫–∏</h1><div id="riddle-box" class="ai-response-box">...</div><button class="btn btn-ai" onclick="generateRiddle()">‚ú® –ù–û–í–ê–Ø</button><button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button></div>
        <div id="cafe-screen" class="screen hidden"><h1>‚òï –ö–∞—Ñ–µ</h1><input type="text" id="cafe-order" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–µ–ª—å–º–µ–Ω–∏"><button class="btn btn-ai" onclick="orderFood()">‚ú® –ó–ê–ö–ê–ó–ê–¢–¨</button><div id="cafe-response" class="ai-response-box">–ñ–¥—É –∑–∞–∫–∞–∑...</div><button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button></div>
    </div>
    <canvas id="gameCanvas"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAbV_OZuunOU1H1fXEimpK9abmqhG25ffw",
      authDomain: "moon-aliens.firebaseapp.com",
      projectId: "moon-aliens",
      storageBucket: "moon-aliens.firebasestorage.app",
      messagingSenderId: "277959045140",
      appId: "1:277959045140:web:fe5cf6f61f967b09fe3701",
      measurementId: "G-375KCYZZSZ"
    };

    let db, auth;
    window.isFirebaseActive = false;

    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        signInAnonymously(auth)
            .then(() => { 
                console.log("Firebase OK"); 
                window.isFirebaseActive = true; 
                document.getElementById('debug-bar').innerText = "v12.0 | AI: " + (getSavedKey() ? "OK" : "–ù–ï–¢") + " | –û–±–ª–∞–∫–æ: ‚úÖ";
                document.getElementById('debug-bar').style.color = "#00ff00";
            })
            .catch(e => {
                document.getElementById('debug-bar').innerText = "v12.0 | –û–±–ª–∞–∫–æ: –û–®–ò–ë–ö–ê";
                document.getElementById('debug-bar').style.color = "orange";
            });
    } catch (e) {}

    window.saveScoreCloud = async (name, score) => {
        if (!window.isFirebaseActive) return false;
        try { 
            await addDoc(collection(db, 'scores'), { name: name, score: score, timestamp: Date.now() }); 
            return true; 
        } catch (e) { 
            alert("–û–®–ò–ë–ö–ê –û–ë–õ–ê–ö–ê: " + e.message);
            return false; 
        }
    };
    window.getScoresCloud = async () => {
        if (!window.isFirebaseActive) return null;
        try {
            const snap = await getDocs(collection(db, 'scores'));
            let r = []; snap.forEach(d => r.push(d.data()));
            return r.sort((a,b) => b.score - a.score).slice(0, 10);
        } catch (e) { 
            alert("–û–®–ò–ë–ö–ê –ß–¢–ï–ù–ò–Ø: " + e.message);
            return null; 
        }
    };
</script>

<script>
    window.getSavedKey = function() { return localStorage.getItem('moon_ai_key_v5'); };
    window.saveApiKey = function() { const k=document.getElementById('api-key-input').value.trim(); if(k.indexOf("AIza") === 0){localStorage.setItem('moon_ai_key_v5',k); document.getElementById('key-status').innerText="OK!"; setTimeout(function(){showScreen('start-screen')},500);} else { document.getElementById('key-status').innerText="–û—à–∏–±–∫–∞"; } };
    window.generateGameQR = function() { const d=document.getElementById('qrcode'); d.innerHTML=""; document.getElementById('qrcode-container').classList.remove('hidden'); try { new QRCode(d, {text:window.location.href, width:128, height:128}); } catch(e) { alert("QR –æ—à–∏–±–∫–∞: " + e.message); } };
    
    window.callGemini = async function(p) { 
        const k = getSavedKey(); if(!k)return "–ù–ï–¢ –ö–õ–Æ–ß–ê"; 
        try{
            const r=await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key="+k,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:p}]}]})});
            const d=await r.json(); return d.candidates?d.candidates[0].content.parts[0].text:"–ü–£–°–¢–û";
        }catch(e){return e.message;} 
    };

    const LOCAL_KEY = 'moon_v4_local';
    window.saveScore = async function(name, sc) {
        let ls=JSON.parse(localStorage.getItem(LOCAL_KEY)||"[]"); ls.push({name:name,score:sc}); ls.sort(function(a,b){return b.score-a.score}); localStorage.setItem(LOCAL_KEY,JSON.stringify(ls.slice(0,10)));
        if(window.saveScoreCloud) await window.saveScoreCloud(name, sc);
        return ls[0].score===sc;
    };

    window.showLeaderboard = async function() {
        showScreen('leaderboard-screen');
        const l = document.getElementById('leaderboard-list'); 
        l.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        let s = []; let source = "–õ–æ–∫–∞–ª—å–Ω—ã–µ";
        if(window.getScoresCloud) { const cs = await window.getScoresCloud(); if(cs) { if (cs.length === 0) { source = "–û–±–ª–∞–∫–æ (–ü—É—Å—Ç–æ)"; s = []; } else { s = cs; source = "üèÜ –û–±–ª–∞–∫–æ üèÜ"; } } }
        if(s.length===0 && source !== "–û–±–ª–∞–∫–æ (–ü—É—Å—Ç–æ)") { s = JSON.parse(localStorage.getItem(LOCAL_KEY)||"[]"); source = "–õ–æ–∫–∞–ª—å–Ω—ã–µ (–°–±–æ–π)"; }
        document.getElementById('leaderboard-status').innerText = source;
        l.innerHTML = "";
        if(s.length===0) l.innerHTML = "<p>–ü—É—Å—Ç–æ! –°—ã–≥—Ä–∞–π –ø–µ—Ä–≤—ã–º.</p>";
        else s.forEach(function(e,i){ l.innerHTML += '<li class="leaderboard-item"><span>'+(i+1)+'. '+e.name+'</span><b>'+e.score+'</b></li>'; });
    };

    window.showScreen = function(id){document.querySelectorAll('.screen').forEach(function(e){e.classList.add('hidden')});if(id)document.getElementById(id).classList.remove('hidden');};

    // --- GAME LOGIC ---
    var cvs, ctx, W, H;
    var st='MENU', sc=0, lives=3, startT=0, spawnT=0, aliens=[], parts=[], texts=[];
    var combo=0, comboT=0, shake=0;

    window.startGame = function() {
        const n=document.getElementById('player-name').value.trim();
        if(!n){document.getElementById('player-name').style.border="4px solid red";return;}
        localStorage.setItem('moon_name',n);
        sc=0; lives=3; startT=Date.now(); aliens=[]; parts=[]; texts=[]; combo=0;
        updLives(); document.getElementById('score-val').innerText=0;
        st='PLAYING'; showScreen(null); document.getElementById('game-ui').classList.remove('hidden');
    };

    function loseLife(){ if(st!=='PLAYING')return; lives--; updLives(); shake=15; var f=document.getElementById('damage-flash');f.style.opacity=0.5;setTimeout(function(){f.style.opacity=0},100); if(lives<=0)gameOver("–ö–æ–Ω–µ—Ü!"); }
    function updLives(){ document.getElementById('lives-container').innerText="‚ù§Ô∏è".repeat(lives)+"üñ§".repeat(3-lives); }
    async function gameOver(m){ st='GAMEOVER'; document.getElementById('final-score').innerText=sc; document.getElementById('game-over-msg').innerText=m; document.getElementById('game-ui').classList.add('hidden'); const n=document.getElementById('player-name').value||"A"; await saveScore(n,sc); showScreen('game-over-screen'); }

    // --- –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –û–¢–†–ò–°–û–í–ö–ò (ART CODE) ---
    
    function drawGoodAlien(ctx, x, y, scale) {
        ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
        // –ê–Ω—Ç–µ–Ω–Ω—ã
        ctx.strokeStyle = '#74d663'; ctx.lineWidth = 8; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(-20, -30); ctx.quadraticCurveTo(-40, -60, -50, -60); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(20, -30); ctx.quadraticCurveTo(40, -60, 50, -60); ctx.stroke();
        var grdBall = ctx.createRadialGradient(-50,-60,2, -50,-60,12); grdBall.addColorStop(0, '#b6f2a3'); grdBall.addColorStop(1, '#5db84e'); ctx.fillStyle = grdBall; ctx.beginPath(); ctx.arc(-50, -60, 12, 0, Math.PI*2); ctx.fill();
        var grdBall2 = ctx.createRadialGradient(50,-60,2, 50,-60,12); grdBall2.addColorStop(0, '#b6f2a3'); grdBall2.addColorStop(1, '#5db84e'); ctx.fillStyle = grdBall2; ctx.beginPath(); ctx.arc(50, -60, 12, 0, Math.PI*2); ctx.fill();
        // –°–≤–µ—á–µ–Ω–∏–µ –∏ –ì–æ–ª–æ–≤–∞
        ctx.shadowBlur = 20; ctx.shadowColor = "#fef08a";
        var grdHead = ctx.createRadialGradient(-15, -15, 10, 0, 0, 55); grdHead.addColorStop(0, '#86efac'); grdHead.addColorStop(1, '#4ade80'); ctx.fillStyle = grdHead; ctx.beginPath(); ctx.arc(0, 0, 55, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;
        // –ì–ª–∞–∑–∞ –∏ –ë–ª–∏–∫–∏
        ctx.fillStyle = '#1a2e05'; ctx.beginPath(); ctx.ellipse(-20, -10, 14, 18, -0.1, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(20, -10, 14, 18, 0.1, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(-24, -18, 5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(16, -18, 5, 0, Math.PI*2); ctx.fill();
        // –©–µ—á–∫–∏ –∏ –†–æ—Ç
        ctx.fillStyle = '#f472b6'; font = "24px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("‚ù§Ô∏è", -35, 15); ctx.fillText("‚ù§Ô∏è", 35, 15);
        ctx.fillStyle = '#9f1239'; ctx.beginPath(); ctx.arc(0, 10, 12, 0, Math.PI, false); ctx.fill();
        ctx.fillStyle = '#fb7185'; ctx.beginPath(); ctx.arc(0, 18, 6, 0, Math.PI, false); ctx.fill();
        ctx.restore();
    }

    function drawBadAlien(ctx, x, y, scale) {
        ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
        // –°–≤–µ—á–µ–Ω–∏–µ –∏ –¢–µ–ª–æ
        ctx.shadowBlur = 15; ctx.shadowColor = "#fde047";
        var grd = ctx.createRadialGradient(-10, -10, 5, 0, 0, 60); grd.addColorStop(0, '#7c3aed'); grd.addColorStop(1, '#4c1d95'); ctx.fillStyle = grd;
        ctx.beginPath(); ctx.moveTo(-30, -30); ctx.lineTo(-50, -70); ctx.lineTo(-20, -40); ctx.lineTo(0, -30); ctx.lineTo(20, -40); ctx.lineTo(50, -60); ctx.lineTo(40, -20); ctx.quadraticCurveTo(70, 0, 60, 40); ctx.quadraticCurveTo(40, 60, 0, 55); ctx.quadraticCurveTo(-60, 50, -50, 0); ctx.closePath(); ctx.fill(); ctx.shadowBlur = 0;
        ctx.strokeStyle = '#3b0764'; ctx.lineWidth = 2; ctx.stroke();
        
        // --- –ù–û–í–´–ï –ó–õ–´–ï –î–ï–¢–ê–õ–ò ---
        // –ë—Ä–æ–≤–∏ (–ù–∞—Ö–º—É—Ä–µ–Ω–Ω—ã–µ)
        ctx.strokeStyle = '#2e1065'; ctx.lineWidth = 6; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(-35, -28); ctx.lineTo(-5, -18); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(35, -28); ctx.lineTo(5, -18); ctx.stroke();

        // –ì–ª–∞–∑–∞ (–í–ø–∞–¥–∏–Ω—ã)
        ctx.fillStyle = '#1e1b4b'; ctx.beginPath(); ctx.arc(-20, -10, 12, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(20, -10, 12, 0, Math.PI*2); ctx.fill();
        // –ó—Ä–∞—á–∫–∏ (–ö–†–ê–°–ù–´–ï –ö—Ä–µ—Å—Ç–∏–∫–∏)
        ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 4; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(-25, -15); ctx.lineTo(-15, -5); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-15, -15); ctx.lineTo(-25, -5); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(15, -15); ctx.lineTo(25, -5); ctx.stroke(); ctx.beginPath(); ctx.moveTo(25, -15); ctx.lineTo(15, -5); ctx.stroke();

        // –†–æ—Ç (–û—Å–∫–∞–ª/–ó–∏–≥–∑–∞–≥)
        ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.lineJoin = 'round';
        ctx.beginPath();
        ctx.moveTo(-25, 25); ctx.lineTo(-15, 35); ctx.lineTo(-5, 25); ctx.lineTo(5, 35); ctx.lineTo(15, 25); ctx.lineTo(25, 35);
        ctx.stroke();
        // -------------------------

        ctx.restore();
    }

    function Alien() {
        this.x = Math.random()*(W-100)+50;
        this.y = Math.random()*(H-200)+100;
        this.vx = (Math.random()-0.5)*2;
        this.vy = (Math.random()-0.5)*2;
        this.bad = Math.random()<0.25;
        this.t = Date.now();
        this.s = 0;
        this.st = 'up';
    }
    Alien.prototype.upd = function(s, stay) {
        this.x+=this.vx*s; this.y+=this.vy*s;
        if(this.x<50||this.x>W-50)this.vx*=-1; if(this.y<100||this.y>H-100)this.vy*=-1;
        if(this.st=='up'){this.s+=0.1;if(this.s>=1)this.st='wait';}
        else if(this.st=='wait'){if(Date.now()-this.t>stay)this.st='down';}
        else if(this.st=='down'){this.s-=0.15;if(this.s<=0){this.st='dead';if(!this.clk&&!this.bad)loseLife();}}
    };
    Alien.prototype.drw = function() {
        if(this.st=='dead')return;
        if(this.bad) drawBadAlien(ctx, this.x, this.y, this.s);
        else drawGoodAlien(ctx, this.x, this.y, this.s);
    };

    function Part(x,y,c){this.x=x;this.y=y;this.c=c;this.vx=(Math.random()-0.5)*15;this.vy=(Math.random()-0.5)*15;this.l=1;}
    Part.prototype.upd=function(){this.x+=this.vx;this.y+=this.vy;this.vy+=0.5;this.l-=0.05;};
    Part.prototype.drw=function(){ctx.globalAlpha=this.l;ctx.fillStyle=this.c;ctx.beginPath();ctx.arc(this.x,this.y,6,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;};

    function Txt(x,y,t,c){this.x=x;this.y=y;this.t=t;this.c=c;this.l=1;}
    Txt.prototype.upd=function(){this.y-=2;this.l-=0.02;};
    Txt.prototype.drw=function(){ctx.globalAlpha=Math.max(0,this.l);ctx.fillStyle=this.c;ctx.font="bold 30px Arial";ctx.fillText(this.t,this.x,this.y);ctx.globalAlpha=1;};

    // --- INPUT ---
    function handleInput(e) {
        if(st!=='PLAYING')return;
        if(e.cancelable && e.type === 'touchstart') e.preventDefault();
        var r=cvs.getBoundingClientRect();
        var cx=e.changedTouches?e.changedTouches[0].clientX:e.clientX;
        var cy=e.changedTouches?e.changedTouches[0].clientY:e.clientY;
        var x=cx-r.left, y=cy-r.top;

        for(var i=aliens.length-1;i>=0;i--){
            var a=aliens[i];
            if(Math.sqrt(Math.pow(x-a.x,2)+Math.pow(y-a.y,2))<90 && a.s>0.3 && a.st!=='dead'){
                if(a.bad){
                    for(var j=0;j<10;j++)parts.push(new Part(a.x,a.y,'#ef4444'));
                    gameOver("–°–∫–µ–ª–µ—Ç!");
                } else {
                    a.clk=true; a.st='dead';
                    for(var j=0;j<10;j++)parts.push(new Part(a.x,a.y,'#fcd34d'));
                    sc+=10; document.getElementById('score-val').innerText=sc;
                    texts.push(new Txt(a.x,a.y,"+10",'#fcd34d'));
                }
                break;
            }
        }
    }

    // --- QUIZ & AI ---
    window.nextQuizQuestion = async function() {
        showScreen('quiz-screen');
        document.getElementById('quiz-question').innerText=""; document.getElementById('quiz-options').innerHTML=""; document.getElementById('quiz-feedback').innerText="";
        document.getElementById('quiz-loading').classList.remove('hidden'); document.getElementById('quiz-content').classList.add('hidden'); document.getElementById('btn-next-quiz').classList.add('hidden');
        var t=await callGemini("–ü—Ä–∏–¥—É–º–∞–π –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–æ—Å–º–æ—Å 10 –ª–µ—Ç. –§–æ—Ä–º–∞—Ç: –í–æ–ø—Ä–æ—Å|||–û—Ç–≤1|||–û—Ç–≤2|||–û—Ç–≤3|||–ò–Ω–¥(1-3)");
        if(t.indexOf("–û–®–ò–ë–ö–ê")!==-1 || t.indexOf("–ü–£–°–¢–û")!==-1) { document.getElementById('quiz-question').innerText=t; document.getElementById('quiz-loading').classList.add('hidden'); document.getElementById('quiz-content').classList.remove('hidden'); return; }
        var p=t.split('|||');
        if(p.length>=5){
            document.getElementById('quiz-question').innerText=p[0];
            [1,2,3].forEach(function(ix){ var b=document.createElement('button'); b.className='btn btn-option'; b.innerText=p[ix]; b.onclick=function(){checkQuiz(ix,parseInt(p[4]),b)}; document.getElementById('quiz-options').appendChild(b); });
            document.getElementById('quiz-loading').classList.add('hidden'); document.getElementById('quiz-content').classList.remove('hidden');
        } else { document.getElementById('quiz-question').innerText=t; document.getElementById('quiz-loading').classList.add('hidden'); document.getElementById('quiz-content').classList.remove('hidden'); }
    };
    function checkQuiz(i,c,b){ var f=document.getElementById('quiz-feedback'); if(i==c){f.innerText="–í–µ—Ä–Ω–æ!";f.style.color="#4ade80"}else{b.style.background="#ef4444";f.innerText="–ù–µ—Ç"} document.getElementById('btn-next-quiz').classList.remove('hidden'); }
    window.generateRiddle = async function(){ var b=document.getElementById('riddle-box');b.innerText="...";var t=await callGemini("–ó–∞–≥–∞–¥–∫–∞ –∫–æ—Å–º–æ—Å. –§–æ—Ä–º–∞—Ç: –ó–∞–≥–∞–¥–∫–∞|||–û—Ç–≤–µ—Ç");var p=t.split('|||');if(p.length>=2)b.innerHTML='<div>'+p[0]+'</div><div onclick="this.innerText=\''+p[1]+'\'" style="padding:10px;background:#333">***</div>';else b.innerText=t; };
    window.orderFood = async function(){ var v=document.getElementById('cafe-order').value;if(!v)return;document.getElementById('cafe-response').innerText="...";document.getElementById('cafe-response').innerText=await callGemini("–û–ø–∏—à–∏ –∫–æ—Å–º–∏—á. –µ–¥—É: "+v); };

    // --- LOOP ---
    function loop(t){
        if(st==='PLAYING'){
            var d=Math.min((Date.now()-startT)/35000,1);
            document.getElementById('danger-bar').style.width=(d*100)+'%';
            if(t>spawnT){aliens.push(new Alien());spawnT=t+(1200-850*d);}
        }
        ctx.fillStyle='#0b0d17';ctx.fillRect(0,0,W,H);
        
        ctx.fillStyle='white'; for(var i=0;i<50;i++) ctx.fillRect((Math.sin(i*9)*W+W+t/20)%W, (Math.cos(i*5)*H+H)%H, Math.random()*2, Math.random()*2);
        ctx.fillStyle='#e2e8f0'; ctx.beginPath();ctx.ellipse(W/2,H+350,W,450,0,0,Math.PI*2);ctx.fill();
        
        aliens.forEach(function(a){a.upd(1+3*(Math.min((Date.now()-startT)/35000,1)),2000);a.drw()});
        aliens=aliens.filter(function(a){return a.st!=='dead'});
        
        parts.forEach(function(p){p.upd();p.drw()}); parts=parts.filter(function(p){return p.l>0});
        texts.forEach(function(x){x.upd();x.drw()}); texts=texts.filter(function(x){return x.l>0});
        
        requestAnimationFrame(loop);
    }

    // INIT
    window.onload = function() {
        cvs=document.getElementById('gameCanvas'); ctx=cvs.getContext('2d');
        function resize(){W=window.innerWidth;H=window.innerHeight;cvs.width=W;cvs.height=H;} 
        window.addEventListener('resize',resize); resize();
        cvs.addEventListener('mousedown',handleInput); 
        cvs.addEventListener('touchstart',handleInput,{passive:false});
        if(localStorage.getItem('moon_name'))document.getElementById('player-name').value=localStorage.getItem('moon_name'); 
        if(!getSavedKey())document.getElementById('debug-bar').style.color="yellow";
        requestAnimationFrame(loop);
    };
</script>
</body>
</html>
