<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ—É–Ω–Ω—ã–µ –ü—Ä–∏—à–µ–ª—å—Ü—ã v2.0</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0b0d17;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* DEBUG BAR (–î–õ–Ø –û–¢–õ–ê–î–ö–ò) */
        #debug-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            font-size: 12px;
            padding: 5px;
            z-index: 9999;
            pointer-events: none;
            text-align: center;
            border-bottom: 1px solid #00ff00;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 10;
        }

        .screen {
            pointer-events: auto;
            background: rgba(11, 13, 23, 0.95);
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            border: 4px solid #4ade80;
            box-shadow: 0 0 20px #4ade80;
            max-width: 90%;
            width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        h1 { color: #fff; margin: 0 0 20px 0; font-size: 28px; }
        p { color: #ccc; font-size: 18px; line-height: 1.5; }

        .btn {
            background: #4ade80; color: #000; border: none; padding: 15px 30px; font-size: 20px;
            border-radius: 50px; cursor: pointer; font-weight: bold; margin: 10px auto;
            display: block; width: 80%; touch-action: manipulation;
        }
        .btn:active { transform: scale(0.95); }

        .btn-ai {
            background: linear-gradient(45deg, #a78bfa, #f472b6); color: white;
            box-shadow: 0 0 15px #a78bfa; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .btn-option {
            background: #334155; color: white; text-align: left; font-size: 18px;
            padding: 15px 20px; width: 100%; box-sizing: border-box; margin: 8px 0;
            border: 2px solid #4ade80; border-radius: 12px;
        }

        input[type="text"] {
            padding: 15px; border-radius: 12px; border: 2px solid #4ade80;
            background: #222; color: white; font-size: 18px; width: 85%;
            margin-bottom: 15px; text-align: center; display: block; margin-left: auto; margin-right: auto;
        }

        .ai-response-box {
            background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 12px; margin: 15px 0;
            min-height: 60px; color: #bef264; font-style: italic; white-space: pre-wrap; font-size: 18px;
        }

        /* –¢–ê–ë–õ–ò–¶–ê –†–ï–ö–û–†–î–û–í */
        .leaderboard-list {
            list-style: none; padding: 0; margin: 0; text-align: left;
            max-height: 300px; overflow-y: auto;
        }
        .leaderboard-item {
            background: rgba(255,255,255,0.1); margin-bottom: 8px; padding: 10px 15px;
            border-radius: 10px; display: flex; justify-content: space-between;
            color: white; font-size: 18px;
        }
        .medal { margin-right: 10px; }
        .score-num { font-weight: bold; color: #fcd34d; }

        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* UI –ò–ì–†–´ */
        #game-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; padding: 10px; box-sizing: border-box;
        }
        #score-board {
            position: absolute; top: 35px; /* –ß—É—Ç—å –Ω–∏–∂–µ –∏–∑-–∑–∞ debug bar */
            left: 15px; color: white; font-size: 24px; font-weight: bold;
            background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 15px;
            border: 2px solid #4ade80; display: flex; flex-direction: column; align-items: flex-start; z-index: 20;
        }
        #combo-display { font-size: 18px; color: #fcd34d; margin-top: 5px; opacity: 0; transition: opacity 0.2s; }
        #lives-container {
            position: absolute; top: 35px; right: 15px; font-size: 30px;
            background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 15px;
            border: 2px solid #ef4444; letter-spacing: 5px; z-index: 20;
        }
        #danger-bar {
            position: absolute; bottom: 0; left: 0; height: 8px;
            background: linear-gradient(90deg, #4ade80, #fcd34d, #ef4444); width: 0%;
            transition: width 0.5s linear; z-index: 4;
        }
        #damage-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: red; opacity: 0; pointer-events: none; transition: opacity 0.1s; z-index: 30;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- –û–¢–õ–ê–î–û–ß–ù–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <div id="debug-bar">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ä—Å–∏–∏ v2.0...</div>

    <div id="damage-flash"></div>
    <div id="danger-bar"></div>
    
    <div id="game-ui" class="hidden">
        <div id="score-board">
            <span>–û—á–∫–∏: <span id="score-val">0</span></span>
            <div id="combo-display">COMBO x2!</div>
        </div>
        <div id="lives-container">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div id="ui-layer">
        <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
        <div id="start-screen" class="screen">
            <h1>üëΩ –õ—É–Ω–Ω—ã–µ –ü—Ä–∏—à–µ–ª—å—Ü—ã üåë</h1>
            <input type="text" id="player-name" placeholder="–¢–≤–æ–µ –∏–º—è –∫–æ—Å–º–æ–Ω–∞–≤—Ç–∞" maxlength="12">
            <p style="font-size: 16px; margin-top: 5px;">–ñ–º–∏ –Ω–∞ ‚ù§Ô∏è! –ù–µ –∂–º–∏ –Ω–∞ üíÄ!</p>
            <button class="btn" onclick="startGame()">üöÄ –ü–û–õ–ï–¢–ï–õ–ò!</button>
            <button class="btn" style="background: #fcd34d" onclick="showLeaderboard()">üèÜ –†–ï–ö–û–†–î–´</button>
            <div style="display:flex; justify-content: center; gap: 10px; margin-top: 10px;">
                <button class="btn btn-ai" style="width: auto; padding: 10px 20px; font-size: 16px;" onclick="showScreen('quiz-screen'); nextQuizQuestion();">üéì –ö–≤–∏–∑</button>
                <button class="btn btn-ai" style="width: auto; padding: 10px 20px; font-size: 16px;" onclick="showScreen('crossword-screen')">üß© –ó–∞–≥–∞–¥–∫–∏</button>
                <button class="btn btn-ai" style="width: auto; padding: 10px 20px; font-size: 16px;" onclick="showScreen('cafe-screen')">‚òï –ö–∞—Ñ–µ</button>
            </div>
        </div>

        <!-- –õ–ò–î–ï–†–ë–û–†–î -->
        <div id="leaderboard-screen" class="screen hidden">
            <h1>üèÜ –ó–∞–ª –°–ª–∞–≤—ã</h1>
            <p id="leaderboard-status" style="font-size: 14px; color: #aaa;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            <ul id="leaderboard-list" class="leaderboard-list"></ul>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
        </div>

        <!-- –ö–û–ù–ï–¶ –ò–ì–†–´ -->
        <div id="game-over-screen" class="screen hidden">
            <h1 style="color: #ff4d4d">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê üíÄ</h1>
            <p id="game-over-msg">–ñ–∏–∑–Ω–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!</p>
            <p style="font-size: 24px; color: #fcd34d;">–¢–≤–æ–π —Å—á–µ—Ç: <span id="final-score">0</span></p>
            <div id="new-record-msg" class="hidden" style="color: #4ade80; font-weight: bold; font-size: 20px; margin-bottom: 10px;">üéâ –ù–û–í–´–ô –†–ï–ö–û–†–î! üéâ</div>
            <button class="btn" onclick="startGame()">–ï–©–Å –†–ê–ó</button>
            <button class="btn" style="background: #fcd34d" onclick="showLeaderboard()">üèÜ –¢–ê–ë–õ–ò–¶–ê</button>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ú–ï–ù–Æ</button>
        </div>

        <!-- –ö–í–ò–ó/–ó–ê–ì–ê–î–ö–ò/–ö–ê–§–ï -->
        <div id="quiz-screen" class="screen hidden">
            <h1>üéì –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –ö–≤–∏–∑</h1>
            <div id="quiz-loading"><p class="loading">–ó–∞–≥—Ä—É–∂–∞—é –≤–æ–ø—Ä–æ—Å...</p></div>
            <div id="quiz-content" class="hidden"><p id="quiz-question" style="font-weight: bold; color: white;"></p><div id="quiz-options"></div><p id="quiz-feedback"></p></div>
            <button id="btn-next-quiz" class="btn btn-ai hidden" onclick="nextQuizQuestion()">–°–õ–ï–î–£–Æ–©–ò–ô –í–û–ü–†–û–°</button>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
        </div>
        <div id="crossword-screen" class="screen hidden">
            <h1>üß© –õ—É–Ω–Ω—ã–µ –ó–∞–≥–∞–¥–∫–∏</h1>
            <div id="riddle-box" class="ai-response-box">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∑–∞–≥–∞–¥–∫–∞...</div>
            <button class="btn btn-ai" onclick="generateRiddle()">‚ú® –ù–û–í–ê–Ø –ó–ê–ì–ê–î–ö–ê</button>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
        </div>
        <div id="cafe-screen" class="screen hidden">
            <h1>‚òï –õ—É–Ω–Ω–æ–µ –ö–∞—Ñ–µ</h1>
            <input type="text" id="cafe-order" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–µ–ª—å–º–µ–Ω–∏">
            <button class="btn btn-ai" onclick="orderFood()">‚ú® –ó–ê–ö–ê–ó–ê–¢–¨</button>
            <div id="cafe-response" class="ai-response-box">–ñ–¥—É –∑–∞–∫–∞–∑...</div>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<!-- FIREBASE SDK -->
<script type="module">
    // --- 1. FIREBASE –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
    // –ü–ê–ü–ê, –í–°–¢–ê–í–¨ –°–Æ–î–ê –ö–û–ù–§–ò–ì –ò–ó FIREBASE CONSOLE:
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAbV_OZuunOU1H1fXEimpK9abmqhG25ffw",
  authDomain: "moon-aliens.firebaseapp.com",
  projectId: "moon-aliens",
  storageBucket: "moon-aliens.firebasestorage.app",
  messagingSenderId: "277959045140",
  appId: "1:277959045140:web:fe5cf6f61f967b09fe3701",
  measurementId: "G-375KCYZZSZ"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    let db = null;
    let auth = null;
    window.isFirebaseActive = false;

    // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ Firebase
    try {
        if (firebaseConfig.apiKey) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            signInAnonymously(auth).then(() => {
                console.log("Firebase Connected");
                window.isFirebaseActive = true;
                updateDebugInfo();
            }).catch(e => {
                console.error("Firebase Auth Error", e);
                updateDebugInfo("–û—à–∏–±–∫–∞ Auth");
            });
        }
    } catch (e) { console.log("Firebase not configured"); }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–ª–∞–∫–∞
    window.saveScoreCloud = async (name, score) => {
        if (!window.isFirebaseActive || !db) return false;
        try {
            await addDoc(collection(db, 'scores'), { name, score, timestamp: Date.now() });
            return true;
        } catch (e) { return false; }
    };

    window.getScoresCloud = async () => {
        if (!window.isFirebaseActive || !db) return null;
        try {
            const snap = await getDocs(collection(db, 'scores'));
            let s = [];
            snap.forEach(d => s.push(d.data()));
            return s.sort((a, b) => b.score - a.score).slice(0, 10);
        } catch (e) { return null; }
    };
</script>

<script>
    // --- 2. GEMINI API –ö–õ–Æ–ß ---
    // –ü–ê–ü–ê, –í–°–¢–ê–í–¨ –°–Æ–î–ê –ö–õ–Æ–ß AI STUDIO (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞ AIza...):
    const apiKey = "AIzaSyDE-tJ67EVNypwxntltj9LkWjN8iLItu1I"; 

    // --- –û–¢–õ–ê–î–ö–ê ---
    function updateDebugInfo(extra = "") {
        const bar = document.getElementById('debug-bar');
        const keyStatus = apiKey && apiKey.length > 10 ? "OK" : "–ü–£–°–¢–û";
        const fbStatus = window.isFirebaseActive ? "–û–ö" : "–ù–ï–¢";
        bar.innerHTML = `Ver: 2.0 | AI Key: ${keyStatus} | –û–±–ª–∞–∫–æ: ${fbStatus} ${extra}`;
        
        if (keyStatus === "–ü–£–°–¢–û") bar.style.color = "red";
        else bar.style.color = "#00ff00";
    }
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –ø–µ—Ä–≤—ã–µ 5 —Å–µ–∫—É–Ω–¥
    setInterval(updateDebugInfo, 1000);
    setTimeout(updateDebugInfo, 100);

    // --- AI FUNCTIONS ---
    async function callGemini(prompt) {
        if (!apiKey) return "–û–®–ò–ë–ö–ê: API –∫–ª—é—á –Ω–µ –≤—Å—Ç–∞–≤–ª–µ–Ω –≤ –∫–æ–¥ (index.html).";
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        try {
            const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "–ú–æ–ª—á–∞–Ω–∏–µ...";
        } catch (e) { return "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ –∫–ª—é—á–∞."; }
    }

    // --- –õ–ò–î–ï–†–ë–û–†–î (–ì–ò–ë–†–ò–î–ù–´–ô) ---
    const LOCAL_KEY = 'moon_aliens_local_v2';

    async function saveScore(name, newScore) {
        // 1. –õ–æ–∫–∞–ª—å–Ω–æ
        let localScores = JSON.parse(localStorage.getItem(LOCAL_KEY) || "[]");
        localScores.push({ name, score: newScore });
        localScores.sort((a, b) => b.score - a.score);
        localStorage.setItem(LOCAL_KEY, JSON.stringify(localScores.slice(0, 10)));
        
        const isLocalRecord = localScores[0].score === newScore;

        // 2. –û–±–ª–∞–∫–æ
        if (window.saveScoreCloud) {
            await window.saveScoreCloud(name, newScore);
        }
        return isLocalRecord;
    }

    async function showLeaderboard() {
        showScreen('leaderboard-screen');
        const list = document.getElementById('leaderboard-list');
        const status = document.getElementById('leaderboard-status');
        list.innerHTML = "";
        status.innerText = "–°–º–æ—Ç—Ä–∏–º –≤ —Ç–µ–ª–µ—Å–∫–æ–ø...";

        let scores = [];
        let source = "–õ–æ–∫–∞–ª—å–Ω—ã–µ (–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)";

        if (window.getScoresCloud) {
            status.innerText = "–°–≤—è–∑—å —Å–æ —Å–ø—É—Ç–Ω–∏–∫–æ–º...";
            const cloudScores = await window.getScoresCloud();
            if (cloudScores) {
                scores = cloudScores;
                source = "üèÜ –í—Å–µ–ª–µ–Ω–Ω–∞—è (Firebase)";
            }
        }

        if (scores.length === 0) scores = JSON.parse(localStorage.getItem(LOCAL_KEY) || "[]");
        status.innerText = source;

        if (scores.length === 0) list.innerHTML = "<p>–ü–æ–∫–∞ –ø—É—Å—Ç–æ!</p>";
        else {
            scores.forEach((entry, index) => {
                let m = index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : `#${index+1}`;
                list.innerHTML += `<li class="leaderboard-item"><span><span class="medal">${m}</span> ${entry.name||'–ê–Ω–æ–Ω'}</span><span class="score-num">${entry.score}</span></li>`;
            });
        }
    }

    // --- GAME ENGINE ---
    window.onload = function() {
        if(localStorage.getItem('moon_player_name')) document.getElementById('player-name').value = localStorage.getItem('moon_player_name');
        updateDebugInfo();
    };

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let gameState='MENU', score=0, lives=3, width, height;
    let gameStartTime=0, spawnTimer=0, combo=0, comboTimer=0, shakeIntensity=0;
    let aliens=[], particles=[], floatingTexts=[];
    
    function resize() { width=window.innerWidth; height=window.innerHeight; canvas.width=width; canvas.height=height; }
    window.addEventListener('resize', resize); resize();

    class Alien {
        constructor() {
            this.x=Math.random()*(width-100)+50; this.y=Math.random()*(height-200)+100;
            this.vx=(Math.random()-0.5)*2; this.vy=(Math.random()-0.5)*2;
            this.isBad=Math.random()<0.25; this.spawnTime=Date.now(); this.scale=0; this.state='pop-up'; this.clicked=false;
        }
        update(spawnRate, stayTime, speed) {
            const age=Date.now()-this.spawnTime;
            this.x+=this.vx*(speed/2); this.y+=this.vy*(speed/2);
            if(this.x<40||this.x>width-40)this.vx*=-1; if(this.y<80||this.y>height-80)this.vy*=-1;
            if(this.state==='pop-up'){this.scale+=0.1;if(this.scale>=1)this.state='wait';}
            else if(this.state==='wait'){if(age>stayTime)this.state='pop-down';}
            else if(this.state==='pop-down'){this.scale-=0.15;if(this.scale<=0){this.state='dead'; if(!this.clicked && !this.isBad) loseLife();}}
        }
        draw() {
            if(this.state==='dead')return; ctx.save(); ctx.translate(this.x,this.y); ctx.scale(this.scale,this.scale);
            ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.beginPath();ctx.ellipse(0,50,40,15,0,0,Math.PI*2);ctx.fill();
            ctx.fillStyle=this.isBad?'#94a3b8':'#88e064'; ctx.beginPath();ctx.arc(0,0,40,0,Math.PI*2);ctx.fill();
            ctx.fillStyle=this.isBad?'#ef4444':'white'; ctx.beginPath();ctx.arc(-15,-10,12,0,Math.PI*2);ctx.arc(15,-10,12,0,Math.PI*2);ctx.fill();
            ctx.fillStyle='black';ctx.beginPath();ctx.arc(-15,-10,5,0,Math.PI*2);ctx.arc(15,-10,5,0,Math.PI*2);ctx.fill();
            ctx.font="30px Arial";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(this.isBad?"üíÄ":"‚ù§Ô∏è",0,20);ctx.restore();
        }
    }
    class Particle{constructor(x,y,c){this.x=x;this.y=y;this.c=c;this.vx=(Math.random()-0.5)*15;this.vy=(Math.random()-0.5)*15;this.life=1.0;}update(){this.x+=this.vx;this.y+=this.vy;this.vy+=0.5;this.life-=0.03;}draw(){ctx.globalAlpha=this.life;ctx.fillStyle=this.c;ctx.beginPath();ctx.arc(this.x,this.y,6,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1.0;}}
    class FloatTxt{constructor(x,y,t,c){this.x=x;this.y=y;this.t=t;this.c=c;this.life=1.0;}update(){this.y-=2;this.life-=0.02;}draw(){ctx.globalAlpha=Math.max(0,this.life);ctx.fillStyle=this.c;ctx.font="bold 30px Arial";ctx.fillText(this.t,this.x,this.y);ctx.globalAlpha=1.0;}}

    function startGame() {
        const name=document.getElementById('player-name').value.trim();
        if(!name){document.getElementById('player-name').style.border="4px solid red"; return;}
        localStorage.setItem('moon_player_name', name);
        score=0; lives=3; combo=0; gameStartTime=Date.now(); aliens=[]; particles=[]; floatingTexts=[];
        updateLives(); document.getElementById('score-val').innerText=0;
        gameState='PLAYING'; showScreen(null); document.getElementById('game-ui').classList.remove('hidden');
    }

    function loseLife(){
        if(gameState!=='PLAYING')return; lives--; updateLives();
        shakeIntensity=15; const f=document.getElementById('damage-flash');f.style.opacity=0.5;setTimeout(()=>f.style.opacity=0,100);
        if(lives<=0) gameOver("–ñ–∏–∑–Ω–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!");
    }
    function updateLives(){document.getElementById('lives-container').innerText="‚ù§Ô∏è".repeat(lives)+"üñ§".repeat(3-lives);}
    
    async function gameOver(msg) {
        gameState='GAMEOVER'; shakeIntensity=20; document.getElementById('final-score').innerText=score;
        document.getElementById('game-over-msg').innerText=msg; document.getElementById('game-ui').classList.add('hidden');
        const name=document.getElementById('player-name').value||"–ê–Ω–æ–Ω";
        const isRec=await saveScore(name, score);
        document.getElementById('new-record-msg').className = isRec ? "" : "hidden";
        showScreen('game-over-screen');
    }

    function showScreen(id){document.querySelectorAll('.screen').forEach(e=>e.classList.add('hidden'));if(id)document.getElementById(id).classList.remove('hidden');}
    canvas.addEventListener('pointerdown',e=>{
        if(gameState!=='PLAYING')return;
        const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top;
        for(let i=aliens.length-1;i>=0;i--){
            const a=aliens[i]; const dist=Math.sqrt((x-a.x)**2+(y-a.y)**2);
            if(dist<70 && a.scale>0.3 && a.state!=='dead'){
                if(a.isBad){for(let j=0;j<15;j++)particles.push(new Particle(a.x,a.y,'#ef4444'));gameOver("–ù–∞–∂–∞–ª –Ω–∞ —Å–∫–µ–ª–µ—Ç–∞!");}
                else{
                    a.clicked=true; a.state='dead'; for(let j=0;j<15;j++)particles.push(new Particle(a.x,a.y,'#fcd34d'));
                    const now=Date.now(); if(now-comboTimer<1200)combo++; else combo=1; comboTimer=now;
                    const pts=10*combo; score+=pts; document.getElementById('score-val').innerText=score;
                    floatingTexts.push(new FloatTxt(a.x,a.y,`+${pts}`, '#fcd34d'));
                }
                break;
            }
        }
    });

    // AI Wrappers
    async function nextQuizQuestion() { 
        showScreen('quiz-screen'); document.getElementById('quiz-loading').classList.remove('hidden'); document.getElementById('quiz-content').classList.add('hidden');
        const txt = await callGemini("–í–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–æ—Å–º–æ—Å –¥–ª—è 10 –ª–µ—Ç. –§–æ—Ä–º–∞—Ç: –í–æ–ø—Ä–æ—Å|||–û—Ç–≤–µ—Ç1|||–û—Ç–≤–µ—Ç2|||–û—Ç–≤–µ—Ç3|||–ò–Ω–¥–µ–∫—Å(1-3)");
        const p = txt.split('|||');
        if(p.length>=5){
            document.getElementById('quiz-question').innerText=p[0]; document.getElementById('quiz-options').innerHTML='';
            [1,2,3].forEach((idx)=>{
                const b=document.createElement('button'); b.className='btn btn-option'; b.innerText=p[idx]; 
                b.onclick=()=>checkQuiz(idx, parseInt(p[4]), b); document.getElementById('quiz-options').appendChild(b);
            });
            document.getElementById('quiz-loading').classList.add('hidden'); document.getElementById('quiz-content').classList.remove('hidden');
        } else document.getElementById('quiz-question').innerText=txt;
    }
    function checkQuiz(i, corr, btn){
        const f=document.getElementById('quiz-feedback');
        if(i===corr){f.innerText="–í–µ—Ä–Ω–æ!";f.style.color="#4ade80";}else{btn.style.background="#ef4444";f.innerText="–û—à–∏–±–∫–∞";}
        document.getElementById('btn-next-quiz').classList.remove('hidden');
    }
    async function generateRiddle(){
        const b=document.getElementById('riddle-box'); b.innerText="–î—É–º–∞—é...";
        const txt=await callGemini("–ó–∞–≥–∞–¥–∫–∞ –ø—Ä–æ –∫–æ—Å–º–æ—Å. –§–æ—Ä–º–∞—Ç: –ó–∞–≥–∞–¥–∫–∞|||–û—Ç–≤–µ—Ç");
        const p=txt.split('|||');
        if(p.length>=2){b.innerHTML=`<div>${p[0]}</div><div onclick="this.innerText='${p[1]}'" style="background:#333;padding:5px;margin-top:10px;">***</div>`;}
        else b.innerText=txt;
    }
    async function orderFood(){
        const v=document.getElementById('cafe-order').value; if(!v)return;
        document.getElementById('cafe-response').innerText = await callGemini(`–û–ø–∏—à–∏ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–µ –±–ª—é–¥–æ: ${v}`);
    }

    function loop(t) {
        let diff=0;
        if(gameState==='PLAYING'){
            diff=Math.min((Date.now()-gameStartTime)/35000, 1.0);
            document.getElementById('danger-bar').style.width=(diff*100)+'%';
            if(t>spawnTimer){aliens.push(new Alien()); spawnTimer=t+(1200-850*diff);}
        }
        
        let sx=0,sy=0; if(shakeIntensity>0){sx=(Math.random()-0.5)*shakeIntensity;sy=(Math.random()-0.5)*shakeIntensity;shakeIntensity*=0.9;}
        ctx.setTransform(1,0,0,1,sx,sy);
        ctx.fillStyle='#0b0d17'; ctx.fillRect(0,0,width,height);
        
        // Stars & Moon
        ctx.fillStyle='white'; for(let i=0;i<50;i++)ctx.fillRect((Math.sin(i*9)*width+width+t/20)%width, (Math.cos(i*5)*height+height)%height, Math.random()*2, Math.random()*2);
        ctx.fillStyle='#e2e8f0'; ctx.beginPath();ctx.ellipse(width/2,height+350,width,450,0,0,Math.PI*2);ctx.fill();

        if(gameState==='PLAYING'){
            aliens.forEach(a=>a.update(0, 2000-1400*diff, 2+6*diff)); aliens.forEach(a=>a.draw()); aliens=aliens.filter(a=>a.state!=='dead');
            particles.forEach(p=>{p.update();p.draw();}); particles=particles.filter(p=>p.life>0);
            floatingTexts.forEach(f=>{f.update();f.draw();}); floatingTexts=floatingTexts.filter(f=>f.life>0);
        } else if(gameState==='MENU'){
             ctx.font="60px Arial"; ctx.fillText("üõ∏", (t/4)%(width+200)-100, height-80+Math.sin(t/200)*5);
        }
        ctx.setTransform(1,0,0,1,0,0); requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

</script>
</body>
</html>
