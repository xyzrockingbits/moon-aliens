<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ—É–Ω–Ω—ã–µ –ü—Ä–∏—à–µ–ª—å—Ü—ã</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0b0d17; /* –ì–ª—É–±–æ–∫–∏–π –∫–æ—Å–º–æ—Å */
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 10;
        }

        .screen {
            pointer-events: auto;
            background: rgba(11, 13, 23, 0.95);
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            border: 4px solid #4ade80;
            box-shadow: 0 0 20px #4ade80;
            max-width: 90%;
            width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        h1 {
            color: #fff;
            margin: 0 0 20px 0;
            font-size: 28px;
        }

        p {
            color: #ccc;
            font-size: 18px;
            line-height: 1.5;
        }

        .btn {
            background: #4ade80;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px auto;
            transition: transform 0.1s;
            display: block;
            width: 80%;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-ai {
            background: linear-gradient(45deg, #a78bfa, #f472b6);
            color: white;
            box-shadow: 0 0 15px #a78bfa;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .btn-option {
            background: #334155;
            color: white;
            text-align: left;
            font-size: 18px;
            padding: 15px 20px;
            width: 100%;
            box-sizing: border-box;
            margin: 8px 0;
            border: 2px solid #4ade80;
            border-radius: 12px;
        }

        input[type="text"] {
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #4ade80;
            background: #222;
            color: white;
            font-size: 18px;
            width: 85%;
            margin-bottom: 15px;
            text-align: center;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .ai-response-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            min-height: 60px;
            color: #bef264;
            font-style: italic;
            white-space: pre-wrap;
            font-size: 18px;
        }

        /* –¢–ê–ë–õ–ò–¶–ê –†–ï–ö–û–†–î–û–í */
        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }
        .leaderboard-item {
            background: rgba(255,255,255,0.1);
            margin-bottom: 8px;
            padding: 10px 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 18px;
        }
        .medal { margin-right: 10px; }
        .score-num { font-weight: bold; color: #fcd34d; }

        .loading {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* UI –ò–ì–†–´ */
        #game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            padding: 10px;
            box-sizing: border-box;
        }

        #score-board {
            position: absolute;
            top: 15px;
            left: 15px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 15px;
            border: 2px solid #4ade80;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            z-index: 20;
        }
        
        #combo-display {
            font-size: 18px;
            color: #fcd34d;
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* –ñ–ò–ó–ù–ò */
        #lives-container {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 30px;
            background: rgba(0,0,0,0.6);
            padding: 5px 15px;
            border-radius: 15px;
            border: 2px solid #ef4444;
            letter-spacing: 5px;
            z-index: 20;
        }

        #danger-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 8px;
            background: linear-gradient(90deg, #4ade80, #fcd34d, #ef4444);
            width: 0%;
            transition: width 0.5s linear;
            z-index: 4;
        }

        #damage-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: red;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s;
            z-index: 30;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="damage-flash"></div>
    <div id="danger-bar"></div>
    
    <div id="game-ui" class="hidden">
        <div id="score-board">
            <span>–û—á–∫–∏: <span id="score-val">0</span></span>
            <div id="combo-display">COMBO x2!</div>
        </div>
        <div id="lives-container">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div id="ui-layer">
        <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
        <div id="start-screen" class="screen">
            <h1>üëΩ –õ—É–Ω–Ω—ã–µ –ü—Ä–∏—à–µ–ª—å—Ü—ã üåë</h1>
            
            <!-- –í–≤–æ–¥ –∏–º–µ–Ω–∏ -->
            <input type="text" id="player-name" placeholder="–¢–≤–æ–µ –∏–º—è –∫–æ—Å–º–æ–Ω–∞–≤—Ç–∞" maxlength="12">
            
            <p style="font-size: 16px; margin-top: 5px;">–ñ–º–∏ –Ω–∞ ‚ù§Ô∏è! –ù–µ –∂–º–∏ –Ω–∞ üíÄ!</p>
            
            <button class="btn" onclick="startGame()">üöÄ –ü–û–õ–ï–¢–ï–õ–ò!</button>
            <button class="btn" style="background: #fcd34d" onclick="showLeaderboard()">üèÜ –†–ï–ö–û–†–î–´</button>
            
            <div style="display:flex; justify-content: center; gap: 10px; margin-top: 10px;">
                <button class="btn btn-ai" style="width: auto; padding: 10px 20px; font-size: 16px;" onclick="showScreen('quiz-screen'); nextQuizQuestion();">üéì –ö–≤–∏–∑</button>
                <button class="btn btn-ai" style="width: auto; padding: 10px 20px; font-size: 16px;" onclick="showScreen('crossword-screen')">üß© –ó–∞–≥–∞–¥–∫–∏</button>
                <button class="btn btn-ai" style="width: auto; padding: 10px 20px; font-size: 16px;" onclick="showScreen('cafe-screen')">‚òï –ö–∞—Ñ–µ</button>
            </div>
        </div>

        <!-- –õ–ò–î–ï–†–ë–û–†–î -->
        <div id="leaderboard-screen" class="screen hidden">
            <h1>üèÜ –ó–∞–ª –°–ª–∞–≤—ã</h1>
            <ul id="leaderboard-list" class="leaderboard-list">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç —Ä–µ–∫–æ—Ä–¥—ã -->
            </ul>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
        </div>

        <!-- –ö–û–ù–ï–¶ –ò–ì–†–´ -->
        <div id="game-over-screen" class="screen hidden">
            <h1 style="color: #ff4d4d">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê üíÄ</h1>
            <p id="game-over-msg">–ñ–∏–∑–Ω–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!</p>
            <p style="font-size: 24px; color: #fcd34d;">–¢–≤–æ–π —Å—á–µ—Ç: <span id="final-score">0</span></p>
            <div id="new-record-msg" class="hidden" style="color: #4ade80; font-weight: bold; font-size: 20px; margin-bottom: 10px;">üéâ –ù–û–í–´–ô –†–ï–ö–û–†–î! üéâ</div>
            
            <button class="btn" onclick="startGame()">–ï–©–Å –†–ê–ó</button>
            <button class="btn" style="background: #fcd34d" onclick="showLeaderboard()">üèÜ –¢–ê–ë–õ–ò–¶–ê</button>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ú–ï–ù–Æ</button>
        </div>

        <!-- –ö–í–ò–ó -->
        <div id="quiz-screen" class="screen hidden">
            <h1>üéì –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –ö–≤–∏–∑</h1>
            <div id="quiz-loading"><p class="loading">–ó–∞–≥—Ä—É–∂–∞—é –≤–æ–ø—Ä–æ—Å...</p></div>
            <div id="quiz-content" class="hidden">
                <p id="quiz-question" style="font-weight: bold; color: white;"></p>
                <div id="quiz-options"></div>
                <p id="quiz-feedback" style="min-height: 20px; font-weight: bold;"></p>
            </div>
            <button id="btn-next-quiz" class="btn btn-ai hidden" onclick="nextQuizQuestion()">–°–õ–ï–î–£–Æ–©–ò–ô –í–û–ü–†–û–°</button>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î –í –ú–ï–ù–Æ</button>
        </div>

        <!-- –ó–ê–ì–ê–î–ö–ò -->
        <div id="crossword-screen" class="screen hidden">
            <h1>üß© –õ—É–Ω–Ω—ã–µ –ó–∞–≥–∞–¥–∫–∏</h1>
            <div id="riddle-box" class="ai-response-box">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∑–∞–≥–∞–¥–∫–∞...</div>
            <button class="btn btn-ai" onclick="generateRiddle()">‚ú® –ù–û–í–ê–Ø –ó–ê–ì–ê–î–ö–ê</button>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
        </div>

        <!-- –ö–ê–§–ï -->
        <div id="cafe-screen" class="screen hidden">
            <h1>‚òï –õ—É–Ω–Ω–æ–µ –ö–∞—Ñ–µ</h1>
            <input type="text" id="cafe-order" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–µ–ª—å–º–µ–Ω–∏">
            <button class="btn btn-ai" onclick="orderFood()">‚ú® –ó–ê–ö–ê–ó–ê–¢–¨</button>
            <div id="cafe-response" class="ai-response-box">–ñ–¥—É –∑–∞–∫–∞–∑...</div>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    // --- –í–ê–ñ–ù–û: –í–°–¢–ê–í–¨ –°–í–û–ô API –ö–õ–Æ–ß –ù–ò–ñ–ï ---
    const apiKey = "AIzaSyDE-tJ67EVNypwxntltj9LkWjN8iLItu1I"; 

    async function callGemini(prompt) {
        if (!apiKey) {
            return "–û—à–∏–±–∫–∞: –ù–µ –≤—Å—Ç–∞–≤–ª–µ–Ω API –∫–ª—é—á –≤ –∫–æ–¥! –ü–∞–ø–∞, –ø—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª index.html :)";
        }
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`HTTP error!`);
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "–ü–æ–º–µ—Ö–∏...";
        } catch (error) {
            console.error(error);
            return "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏.";
        }
    }

    // --- LEADERBOARD SYSTEM (Local Storage) ---
    const STORAGE_KEY = 'moon_aliens_scores_v1';

    function getScores() {
        const scores = localStorage.getItem(STORAGE_KEY);
        return scores ? JSON.parse(scores) : [];
    }

    function saveScoreToLeaderboard(name, newScore) {
        let scores = getScores();
        // –î–æ–±–∞–≤–ª—è–µ–º
        scores.push({ name: name, score: newScore, date: Date.now() });
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)
        scores.sort((a, b) => b.score - a.score);
        // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ø 10
        scores = scores.slice(0, 10);
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º true –µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∫–æ—Ä–¥ (1-–µ –º–µ—Å—Ç–æ)
        return scores.length > 0 && scores[0].score === newScore && scores[0].date === scores.find(s => s.score === newScore).date;
    }

    function showLeaderboard() {
        showScreen('leaderboard-screen');
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = "";
        
        const scores = getScores();
        if (scores.length === 0) {
            list.innerHTML = "<p>–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤. –°—Ç–∞–Ω—å –ø–µ—Ä–≤—ã–º!</p>";
            return;
        }

        scores.forEach((entry, index) => {
            let medal = "";
            if (index === 0) medal = "ü•á";
            else if (index === 1) medal = "ü•à";
            else if (index === 2) medal = "ü•â";
            else medal = `#${index + 1}`;

            const li = document.createElement('li');
            li.className = 'leaderboard-item';
            li.innerHTML = `
                <span><span class="medal">${medal}</span> ${entry.name}</span>
                <span class="score-num">${entry.score}</span>
            `;
            list.appendChild(li);
        });
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = function() {
        const savedName = localStorage.getItem('moon_player_name');
        if (savedName) {
            document.getElementById('player-name').value = savedName;
        }
    };

    // --- AI FUNCTIONS ---
    async function nextQuizQuestion() {
        const els = {
            loading: document.getElementById('quiz-loading'),
            content: document.getElementById('quiz-content'),
            btn: document.getElementById('btn-next-quiz'),
            feedback: document.getElementById('quiz-feedback'),
            options: document.getElementById('quiz-options'),
            question: document.getElementById('quiz-question')
        };
        
        els.loading.classList.remove('hidden');
        els.content.classList.add('hidden');
        els.btn.classList.add('hidden');
        els.feedback.innerText = "";
        els.options.innerHTML = "";

        const prompt = `–ü—Ä–∏–¥—É–º–∞–π –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–æ—Å–º–æ—Å –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞ 10 –ª–µ—Ç. –§–æ—Ä–º–∞—Ç: –í–æ–ø—Ä–æ—Å ||| –û—Ç–≤–µ—Ç1 ||| –û—Ç–≤–µ—Ç2 ||| –û—Ç–≤–µ—Ç3 ||| –ù–æ–º–µ—Ä–ü—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ(1-3)`;
        const text = await callGemini(prompt);
        
        if (text.startsWith("–û—à–∏–±–∫–∞")) {
            els.question.innerText = text;
            els.loading.classList.add('hidden');
            els.content.classList.remove('hidden');
            return;
        }

        const parts = text.split('|||');
        
        if (parts.length >= 5) {
            els.question.innerText = parts[0].trim();
            [parts[1], parts[2], parts[3]].forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-option';
                btn.innerText = opt.trim();
                btn.onclick = () => checkQuizAnswer(i, parseInt(parts[4].trim())-1, btn);
                els.options.appendChild(btn);
            });
            els.loading.classList.add('hidden');
            els.content.classList.remove('hidden');
        } else {
            els.question.innerText = "–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.";
            els.btn.classList.remove('hidden');
            els.loading.classList.add('hidden');
            els.content.classList.remove('hidden');
        }
    }

    function checkQuizAnswer(idx, correct, btn) {
        const feedback = document.getElementById('quiz-feedback');
        document.querySelectorAll('.btn-option').forEach((b, i) => {
            b.disabled = true;
            if (i === correct) b.style.background = '#4ade80';
        });
        
        if (idx === correct) {
            feedback.style.color = '#4ade80';
            feedback.innerText = "–í–µ—Ä–Ω–æ! üéâ";
            createExplosion(width/2, height/2, 'gold');
        } else {
            btn.style.background = '#ff4d4d';
            feedback.style.color = '#ff4d4d';
            feedback.innerText = "–û—à–∏–±–∫–∞.";
        }
        document.getElementById('btn-next-quiz').classList.remove('hidden');
    }

    async function generateRiddle() {
        const box = document.getElementById('riddle-box');
        box.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        const text = await callGemini("–ó–∞–≥–∞–¥–∫–∞ –ø—Ä–æ –∫–æ—Å–º–æ—Å –¥–ª—è –¥–µ—Ç–µ–π. –§–æ—Ä–º–∞—Ç: –ó–∞–≥–∞–¥–∫–∞ ||| –û—Ç–≤–µ—Ç");
        
        if (text.startsWith("–û—à–∏–±–∫–∞")) {
            box.innerText = text;
            return;
        }

        const parts = text.split('|||');
        box.innerHTML = '';
        if(parts.length >= 2) {
            const r = document.createElement('div'); r.innerText = parts[0]; box.appendChild(r);
            const a = document.createElement('div'); 
            a.innerText = "***"; 
            a.style.cssText = "background:#2d3748; padding:5px; margin-top:10px; cursor:pointer; color:#4ade80; display:inline-block;";
            a.onclick = function() { this.innerText = parts[1]; };
            box.appendChild(a);
        } else box.innerText = text;
    }

    async function orderFood() {
        const order = document.getElementById('cafe-order').value;
        const box = document.getElementById('cafe-response');
        if(!order) return;
        box.innerText = "–ì–æ—Ç–æ–≤–ª—é...";
        const text = await callGemini(`–°–º–µ—à–Ω–æ–µ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–ª—é–¥–∞ "${order}" –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞.`);
        box.innerText = text;
    }

    // --- GAME ENGINE ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let gameState = 'MENU'; 
    let score = 0;
    let lives = 3; 
    let width, height;
    
    let gameStartTime = 0;
    let spawnTimer = 0;
    let currentSpawnRate = 1200;
    let currentStayTime = 1800;
    let currentMoveSpeed = 2;

    let combo = 0;
    let comboTimer = 0;
    const COMBO_TIME_LIMIT = 1200; 
    let shakeIntensity = 0;

    let aliens = [];
    let particles = [];
    let floatingTexts = [];
    
    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();

    class FloatingText {
        constructor(x, y, text, color, size = 20) {
            this.x = x;
            this.y = y;
            this.text = text;
            this.color = color;
            this.size = size;
            this.life = 1.0;
            this.vy = -2; 
        }
        update() {
            this.y += this.vy;
            this.life -= 0.02;
        }
        draw() {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.font = `bold ${this.size}px Arial`;
            ctx.textAlign = "center";
            ctx.fillText(this.text, this.x, this.y);
            ctx.globalAlpha = 1.0;
        }
    }

    class Alien {
        constructor() {
            this.radius = 40;
            this.x = Math.random() * (width - 100) + 50;
            this.y = Math.random() * (height - 200) + 100;
            
            this.vx = (Math.random() - 0.5) * currentMoveSpeed;
            this.vy = (Math.random() - 0.5) * currentMoveSpeed;
            
            this.isBad = Math.random() < 0.25; 
            this.spawnTime = Date.now();
            this.scale = 0;
            this.state = 'pop-up'; 
            this.clicked = false; 
            
            this.wobblePhase = Math.random() * Math.PI * 2;
        }

        update() {
            const age = Date.now() - this.spawnTime;
            this.x += this.vx;
            this.y += this.vy;

            if (this.x < 40 || this.x > width - 40) this.vx *= -1;
            if (this.y < 80 || this.y > height - 80) this.vy *= -1;

            if (this.state === 'pop-up') {
                this.scale += 0.1;
                if (this.scale >= 1) {
                    this.scale = 1;
                    this.state = 'wait';
                }
            } else if (this.state === 'wait') {
                if (age > currentStayTime) {
                    this.state = 'pop-down';
                }
            } else if (this.state === 'pop-down') {
                this.scale -= 0.15;
                if (this.scale <= 0) {
                    this.state = 'dead';
                    if (!this.clicked && !this.isBad) {
                        loseLife();
                    }
                }
            }
        }

        draw() {
            if (this.state === 'dead') return;
            ctx.save();
            ctx.translate(this.x, this.y);
            
            const wobble = Math.sin(Date.now() / 200 + this.wobblePhase) * 0.1;
            ctx.rotate(wobble);
            ctx.scale(this.scale, this.scale);

            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath(); ctx.ellipse(0, 50, 40, 15, 0, 0, Math.PI * 2); ctx.fill();

            ctx.fillStyle = this.isBad ? '#94a3b8' : '#88e064'; 
            if (this.isBad) ctx.fillStyle = '#cbd5e1'; 
            
            ctx.beginPath(); ctx.arc(0, 0, 40, 0, Math.PI * 2); ctx.fill();

            const eyeColor = this.isBad ? '#ef4444' : 'white';
            ctx.fillStyle = eyeColor;
            ctx.beginPath(); ctx.arc(-15, -10, 12, 0, Math.PI * 2); ctx.arc(15, -10, 12, 0, Math.PI * 2); ctx.fill();
            
            ctx.fillStyle = 'black';
            ctx.beginPath(); ctx.arc(-15, -10, 5, 0, Math.PI * 2); ctx.arc(15, -10, 5, 0, Math.PI * 2); ctx.fill();

            ctx.font = "30px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(this.isBad ? "üíÄ" : "‚ù§Ô∏è", 0, 20);

            ctx.restore();
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.vx = (Math.random() - 0.5) * 15;
            this.vy = (Math.random() - 0.5) * 15;
            this.life = 1.0;
            this.gravity = 0.5;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.vy += this.gravity;
            this.life -= 0.03;
        }
        draw() {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.beginPath(); ctx.arc(this.x, this.y, 6, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    function startGame() {
        const nameInput = document.getElementById('player-name');
        let playerName = nameInput.value.trim();
        
        if (!playerName) {
            // –ê–Ω–∏–º–∞—Ü–∏—è —Ç—Ä—è—Å–∫–∏ –ø–æ–ª—è –≤–≤–æ–¥–∞, –µ—Å–ª–∏ –∏–º—è –Ω–µ –≤–≤–µ–¥–µ–Ω–æ
            nameInput.style.border = "4px solid red";
            setTimeout(() => nameInput.style.border = "2px solid #4ade80", 500);
            return;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è, —á—Ç–æ–±—ã –Ω–µ –≤–≤–æ–¥–∏—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑
        localStorage.setItem('moon_player_name', playerName);

        score = 0;
        lives = 3; 
        combo = 0;
        gameStartTime = Date.now();
        
        updateLivesUI();
        document.getElementById('score-val').innerText = score;
        document.getElementById('combo-display').style.opacity = 0;
        
        aliens = [];
        particles = [];
        floatingTexts = [];
        
        gameState = 'PLAYING';
        showScreen(null); 
        document.getElementById('game-ui').classList.remove('hidden'); 
    }

    function loseLife() {
        if (gameState !== 'PLAYING') return;

        lives--;
        updateLivesUI();
        
        const flash = document.getElementById('damage-flash');
        flash.style.opacity = 0.5;
        setTimeout(() => flash.style.opacity = 0, 100);
        
        shakeIntensity = 10;

        if (lives <= 0) {
            gameOver("–£–ø—Å! –¢—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø—Ä–∏—à–µ–ª—å—Ü–µ–≤!");
        }
    }

    function updateLivesUI() {
        let hearts = "";
        for (let i = 0; i < lives; i++) hearts += "‚ù§Ô∏è";
        for (let i = lives; i < 3; i++) hearts += "üñ§"; 
        document.getElementById('lives-container').innerText = hearts;
    }

    function gameOver(reason) {
        gameState = 'GAMEOVER';
        shakeIntensity = 20; 
        document.getElementById('final-score').innerText = score;
        document.getElementById('game-over-msg').innerText = reason || "–û–ô! –û—Å—Ç–æ—Ä–æ–∂–Ω–µ–µ!";
        document.getElementById('game-ui').classList.add('hidden');
        
        // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–ê ---
        const playerName = document.getElementById('player-name').value.trim() || "–ö–æ—Å–º–æ–Ω–∞–≤—Ç";
        const isNewRecord = saveScoreToLeaderboard(playerName, score);
        
        const recordMsg = document.getElementById('new-record-msg');
        if (isNewRecord) {
            recordMsg.classList.remove('hidden');
            createExplosion(width/2, height/2, 'gold'); // –°–∞–ª—é—Ç
            createExplosion(width/2 - 50, height/2, 'gold');
            createExplosion(width/2 + 50, height/2, 'gold');
        } else {
            recordMsg.classList.add('hidden');
        }

        showScreen('game-over-screen');
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
        if (id) document.getElementById(id).classList.remove('hidden');
    }

    function createExplosion(x, y, color) {
        for(let i=0; i<15; i++) particles.push(new Particle(x, y, color));
    }

    function spawnAlien() {
        aliens.push(new Alien());
    }

    canvas.addEventListener('pointerdown', (e) => {
        if (gameState !== 'PLAYING') return;

        const rect = canvas.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        
        for (let i = aliens.length - 1; i >= 0; i--) {
            const a = aliens[i];
            const dist = Math.sqrt((clickX - a.x)**2 + (clickY - a.y)**2);
            
            if (dist < 70 && a.scale > 0.3 && a.state !== 'dead') {
                if (a.isBad) {
                    createExplosion(a.x, a.y, '#ef4444');
                    gameOver("–û–π! –¢—ã –Ω–∞–∂–∞–ª –Ω–∞ —Å–∫–µ–ª–µ—Ç–∞!");
                } else {
                    a.clicked = true; 
                    a.state = 'dead';
                    createExplosion(a.x, a.y, '#fcd34d');
                    
                    const now = Date.now();
                    if (now - comboTimer < COMBO_TIME_LIMIT) {
                        combo++;
                    } else {
                        combo = 1;
                    }
                    comboTimer = now;

                    const points = 10 * combo;
                    score += points;
                    document.getElementById('score-val').innerText = score;

                    floatingTexts.push(new FloatingText(a.x, a.y, `+${points}`, '#fcd34d', 30));
                    if (combo > 1) {
                        floatingTexts.push(new FloatingText(a.x, a.y - 30, `x${combo}!`, '#a78bfa', 24));
                        const comboDisplay = document.getElementById('combo-display');
                        comboDisplay.innerText = `COMBO x${combo}! üî•`;
                        comboDisplay.style.opacity = 1;
                        setTimeout(() => comboDisplay.style.opacity = 0, 1000);
                    }
                }
                break;
            }
        }
    });

    function loop(timestamp) {
        if (gameState === 'PLAYING') {
            const timeElapsed = Date.now() - gameStartTime;
            const difficulty = Math.min(timeElapsed / 35000, 1.0);
            
            document.getElementById('danger-bar').style.width = (difficulty * 100) + '%';

            currentSpawnRate = 1200 - (850 * difficulty);
            currentStayTime = 2000 - (1400 * difficulty);
            currentMoveSpeed = 2 + (6 * difficulty);
        }

        let shakeX = 0, shakeY = 0;
        if (shakeIntensity > 0) {
            shakeX = (Math.random() - 0.5) * shakeIntensity;
            shakeY = (Math.random() - 0.5) * shakeIntensity;
            shakeIntensity *= 0.9; 
        }

        ctx.setTransform(1, 0, 0, 1, shakeX, shakeY);
        
        ctx.fillStyle = '#0b0d17';
        ctx.fillRect(0, 0, width, height);

        ctx.fillStyle = 'white';
        for(let i=0; i<60; i++) {
            const speed = (i % 3) + 0.5;
            const sx = (Math.sin(i * 1321) * width + width + timestamp/20 * speed) % width;
            const sy = (Math.cos(i * 543) * height + height) % height;
            const size = Math.random() * 2 + 1;
            ctx.globalAlpha = Math.random() * 0.5 + 0.5;
            ctx.fillRect(sx, sy, size, size);
        }
        ctx.globalAlpha = 1.0;

        ctx.fillStyle = '#e2e8f0';
        ctx.beginPath(); ctx.ellipse(width/2, height + 350, width, 450, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#cbd5e1';
        ctx.beginPath(); ctx.ellipse(width/2 - 100, height - 50, 60, 20, 0, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(width/2 + 150, height - 20, 80, 30, 0, 0, Math.PI*2); ctx.fill();

        if (gameState === 'PLAYING') {
            if (timestamp > spawnTimer) {
                spawnAlien();
                spawnTimer = timestamp + currentSpawnRate;
            }

            aliens.forEach(a => a.update());
            aliens.forEach(a => a.draw());
            aliens = aliens.filter(a => a.state !== 'dead');

            particles.forEach(p => p.update());
            particles.forEach(p => p.draw());
            particles = particles.filter(p => p.life > 0);

            floatingTexts.forEach(t => t.update());
            floatingTexts.forEach(t => t.draw());
            floatingTexts = floatingTexts.filter(t => t.life > 0);
            
        } else if (gameState === 'MENU') {
            const carX = (timestamp / 4) % (width + 200) - 100;
            const carY = height - 80 + Math.sin(timestamp/200)*5;
            ctx.font = "60px Arial";
            ctx.fillText("üõ∏", carX, carY);
        }
        
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        requestAnimationFrame(loop);
    }

    requestAnimationFrame(loop);
</script>
</body>
</html>
