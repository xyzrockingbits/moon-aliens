<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ—É–Ω–Ω—ã–µ –ü—Ä–∏—à–µ–ª—å—Ü—ã v4.4</title>
    
    <script>
        window.onerror = function(msg, url, line, col, error) {
            if (msg.includes("ResizeObserver")) return;
            const box = document.createElement('div');
            box.style.position = 'fixed'; box.style.top = '0'; box.style.left = '0'; box.style.width = '100%'; box.style.height = '100%';
            box.style.backgroundColor = 'blue'; box.style.color = 'white'; box.style.zIndex = '99999';
            box.style.padding = '20px'; box.style.fontFamily = 'monospace'; box.style.fontSize = '14px';
            box.innerHTML = `<h1>üíÄ –û–®–ò–ë–ö–ê –ö–û–î–ê!</h1><p>${msg}</p><p>–°—Ç—Ä–æ–∫–∞: ${line}</p><button onclick="this.parentElement.remove()" style="padding:10px;font-size:20px;margin-top:20px;color:black">–ó–ê–ö–†–´–¢–¨</button>`;
            document.body.appendChild(box);
            return false;
        };
    </script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #0b0d17; font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif; touch-action: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        #gameCanvas { display: block; width: 100vw; height: 100vh; touch-action: none; }
        #debug-bar { position: absolute; top: 0; left: 0; width: 100%; background: rgba(50, 50, 50, 0.9); color: #00ff00; font-size: 10px; padding: 2px; z-index: 10000; text-align: center; border-bottom: 1px solid #00ff00; pointer-events: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: none; z-index: 10; }
        .screen { pointer-events: auto; background: rgba(11, 13, 23, 0.95); padding: 20px; border-radius: 20px; text-align: center; border: 4px solid #4ade80; box-shadow: 0 0 20px #4ade80; max-width: 90%; width: 400px; max-height: 90vh; overflow-y: auto; transition: all 0.3s ease; }
        h1 { color: #fff; margin: 0 0 20px 0; font-size: 26px; }
        p { color: #ccc; font-size: 16px; line-height: 1.4; }
        .btn { background: #4ade80; color: #000; border: none; padding: 12px 24px; font-size: 18px; border-radius: 50px; cursor: pointer; font-weight: bold; margin: 8px auto; display: block; width: 80%; touch-action: manipulation; }
        .btn:active { transform: scale(0.95); }
        .btn-ai { background: linear-gradient(45deg, #a78bfa, #f472b6); color: white; box-shadow: 0 0 10px #a78bfa; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .btn-option { background: #334155; color: white; text-align: left; font-size: 16px; padding: 12px 15px; width: 100%; box-sizing: border-box; margin: 6px 0; border: 2px solid #4ade80; border-radius: 12px; }
        input[type="text"] { padding: 12px; border-radius: 12px; border: 2px solid #4ade80; background: #222; color: white; font-size: 18px; width: 85%; margin-bottom: 15px; text-align: center; display: block; margin-left: auto; margin-right: auto; }
        .ai-response-box { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 12px; margin: 15px 0; min-height: 60px; color: #bef264; font-style: italic; white-space: pre-wrap; font-size: 16px; overflow-wrap: break-word; }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; text-align: left; max-height: 250px; overflow-y: auto; }
        .leaderboard-item { background: rgba(255,255,255,0.1); margin-bottom: 6px; padding: 8px 12px; border-radius: 8px; display: flex; justify-content: space-between; color: white; font-size: 16px; }
        .medal { margin-right: 8px; } .score-num { font-weight: bold; color: #fcd34d; }
        .loading { animation: pulse 1.5s infinite; } @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 10px; box-sizing: border-box; }
        #score-board { position: absolute; top: 25px; left: 10px; color: white; font-size: 20px; font-weight: bold; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 15px; border: 2px solid #4ade80; display: flex; flex-direction: column; align-items: flex-start; z-index: 20; }
        #combo-display { font-size: 16px; color: #fcd34d; margin-top: 2px; opacity: 0; transition: opacity 0.2s; }
        #lives-container { position: absolute; top: 25px; right: 10px; font-size: 24px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 15px; border: 2px solid #ef4444; letter-spacing: 2px; z-index: 20; }
        #danger-bar { position: absolute; bottom: 0; left: 0; height: 6px; background: linear-gradient(90deg, #4ade80, #fcd34d, #ef4444); width: 0%; transition: width 0.5s linear; z-index: 4; }
        #damage-flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; transition: opacity 0.1s; z-index: 30; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="debug-bar">Ver 4.4 (Diag) | –ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="damage-flash"></div>
    <div id="danger-bar"></div>
    
    <div id="game-ui" class="hidden">
        <div id="score-board">
            <span>–û—á–∫–∏: <span id="score-val">0</span></span>
            <div id="combo-display">COMBO x2!</div>
        </div>
        <div id="lives-container">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div id="ui-layer">
        <!-- –ú–ï–ù–Æ -->
        <div id="start-screen" class="screen">
            <h1>üëΩ –õ—É–Ω–Ω—ã–µ –ü—Ä–∏—à–µ–ª—å—Ü—ã üåë</h1>
            <input type="text" id="player-name" placeholder="–ò–º—è –∫–æ—Å–º–æ–Ω–∞–≤—Ç–∞" maxlength="12">
            <p style="font-size: 14px; margin-top: 5px;">–ñ–º–∏ ‚ù§Ô∏è | –ù–µ –∂–º–∏ üíÄ</p>
            <button class="btn" onclick="startGame()">üöÄ –ü–û–õ–ï–¢–ï–õ–ò!</button>
            <button class="btn" style="background: #fcd34d" onclick="showLeaderboard()">üèÜ –†–ï–ö–û–†–î–´</button>
            <div style="display:flex; justify-content: center; gap: 5px; margin-top: 5px;">
                <button class="btn btn-ai" style="padding: 10px; font-size: 14px;" onclick="nextQuizQuestion()">üéì –ö–≤–∏–∑</button>
                <button class="btn btn-ai" style="padding: 10px; font-size: 14px;" onclick="showScreen('crossword-screen')">üß© –ó–∞–≥–∞–¥–∫–∏</button>
                <button class="btn btn-ai" style="padding: 10px; font-size: 14px;" onclick="showScreen('cafe-screen')">‚òï –ö–∞—Ñ–µ</button>
            </div>
        </div>

        <!-- –õ–ò–î–ï–†–ë–û–†–î -->
        <div id="leaderboard-screen" class="screen hidden">
            <h1>üèÜ –ó–∞–ª –°–ª–∞–≤—ã</h1>
            <p id="leaderboard-status" style="font-size: 12px; color: #aaa;">...</p>
            <ul id="leaderboard-list" class="leaderboard-list"></ul>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
        </div>

        <!-- GAME OVER -->
        <div id="game-over-screen" class="screen hidden">
            <h1 style="color: #ff4d4d">–ö–û–ù–ï–¶ üíÄ</h1>
            <p id="game-over-msg">–ñ–∏–∑–Ω–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å!</p>
            <p style="font-size: 22px; color: #fcd34d;">–°—á–µ—Ç: <span id="final-score">0</span></p>
            <div id="new-record-msg" class="hidden" style="color: #4ade80; font-weight: bold; margin-bottom: 10px;">üéâ –†–ï–ö–û–†–î! üéâ</div>
            <button class="btn" onclick="startGame()">–ï–©–Å –†–ê–ó</button>
            <button class="btn" style="background: #fcd34d" onclick="showLeaderboard()">üèÜ –¢–ê–ë–õ–ò–¶–ê</button>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ú–ï–ù–Æ</button>
        </div>

        <!-- –î–û–ü –≠–ö–†–ê–ù–´ -->
        <div id="quiz-screen" class="screen hidden">
            <h1>üéì –ö–≤–∏–∑</h1>
            <div id="quiz-loading"><p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–∞...</p></div>
            <div id="quiz-content" class="hidden">
                <p id="quiz-question" style="font-weight: bold; color: white;"></p>
                <div id="quiz-options"></div>
                <p id="quiz-feedback" style="min-height: 20px; font-weight: bold; margin-top: 10px;"></p>
            </div>
            <button id="btn-next-quiz" class="btn btn-ai hidden" onclick="nextQuizQuestion()">–î–ê–õ–¨–®–ï</button>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
        </div>
        
        <div id="crossword-screen" class="screen hidden">
            <h1>üß© –ó–∞–≥–∞–¥–∫–∏</h1>
            <div id="riddle-box" class="ai-response-box">...</div>
            <button class="btn btn-ai" onclick="generateRiddle()">‚ú® –ù–û–í–ê–Ø</button>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
        </div>
        
        <div id="cafe-screen" class="screen hidden">
            <h1>‚òï –ö–∞—Ñ–µ</h1>
            <input type="text" id="cafe-order" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–µ–ª—å–º–µ–Ω–∏">
            <button class="btn btn-ai" onclick="orderFood()">‚ú® –ó–ê–ö–ê–ó–ê–¢–¨</button>
            <div id="cafe-response" class="ai-response-box">–ñ–¥—É –∑–∞–∫–∞–∑...</div>
            <button class="btn" style="background:#ccc" onclick="showScreen('start-screen')">–ù–ê–ó–ê–î</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<!-- FIREBASE SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    // --- 1. –¢–í–û–ô FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAbV_OZuunOU1H1fXEimpK9abmqhG25ffw",
      authDomain: "moon-aliens.firebaseapp.com",
      projectId: "moon-aliens",
      storageBucket: "moon-aliens.firebasestorage.app",
      messagingSenderId: "277959045140",
      appId: "1:277959045140:web:fe5cf6f61f967b09fe3701",
      measurementId: "G-375KCYZZSZ"
    };

    let db, auth;
    window.isFirebaseActive = false;

    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        signInAnonymously(auth)
            .then(() => { 
                console.log("Firebase OK"); 
                window.isFirebaseActive = true; 
                document.getElementById('debug-bar').innerText = "v4.4 | AI: OK | –û–±–ª–∞–∫–æ: –ü–û–î–ö–õ–Æ–ß–ï–ù–û ‚úÖ";
                document.getElementById('debug-bar').style.color = "#00ff00";
            })
            .catch(e => {
                console.warn("Firebase Auth Error:", e);
                document.getElementById('debug-bar').innerText = "v4.4 | AI: OK | –û–±–ª–∞–∫–æ: –û–®–ò–ë–ö–ê ‚ùå";
                document.getElementById('debug-bar').style.color = "orange";
            });

    } catch (e) {
        console.warn("Firebase Init Error:", e);
    }

    window.saveScoreCloud = async (name, score) => {
        if (!window.isFirebaseActive) return false;
        try { 
            await addDoc(collection(db, 'scores'), { name: name, score: score, timestamp: Date.now() }); 
            return true; 
        } catch (e) { return false; }
    };

    window.getScoresCloud = async () => {
        if (!window.isFirebaseActive) return null;
        try {
            const snap = await getDocs(collection(db, 'scores'));
            let r = []; 
            snap.forEach(d => r.push(d.data()));
            return r.sort((a,b) => b.score - a.score).slice(0, 10);
        } catch (e) { return null; }
    };
</script>

<script>
    // --- 2. –¢–í–û–ô GEMINI API –ö–õ–Æ–ß ---
    const apiKey = "AIzaSyCRWfG8mfc9plyyCniX3_BrlLqXxr0Xphs";

    // --- AI –§–£–ù–ö–¶–ò–ò (–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê) ---
    async function callGemini(prompt) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        // –£–ë–†–ê–õ–ò SETTINGS - –ü—Ä–æ–±—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –æ–Ω–∏ —á–∞—Å—Ç–æ –Ω–∞–¥–µ–∂–Ω–µ–µ
        const payload = { 
            contents: [{ parts: [{ text: prompt }] }]
        };

        try {
            const r = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const d = await r.json();
            
            // –ï–°–õ–ò –û–¢–í–ï–¢ –ï–°–¢–¨
            if (d.candidates && d.candidates[0] && d.candidates[0].content) {
                return d.candidates[0].content.parts[0].text;
            }
            
            // –ï–°–õ–ò –û–¢–í–ï–¢–ê –ù–ï–¢ - –í–´–í–û–î–ò–ú –î–ò–ê–ì–ù–û–°–¢–ò–ö–£
            return "–û–¢–õ–ê–î–ö–ê: " + JSON.stringify(d); // –ü–æ–∫–∞–∂–µ–º –≤–µ—Å—å "–ø–æ—Ç—Ä–æ—Ö" –æ—Ç–≤–µ—Ç–∞

        } catch (e) { return "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e.message; }
    }

    const LOCAL_KEY = 'moon_v4_local';
    async function saveScore(name, sc) {
        let ls = JSON.parse(localStorage.getItem(LOCAL_KEY)||"[]");
        ls.push({name, score:sc}); ls.sort((a,b)=>b.score-a.score);
        localStorage.setItem(LOCAL_KEY, JSON.stringify(ls.slice(0,10)));
        const isLocRec = ls[0].score === sc;
        if(window.saveScoreCloud) await window.saveScoreCloud(name, sc);
        return isLocRec;
    }

    async function showLeaderboard() {
        showScreen('leaderboard-screen');
        const l = document.getElementById('leaderboard-list'); 
        const s_txt = document.getElementById('leaderboard-status');
        l.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        s_txt.innerText = "–°–≤—è–∑—å —Å–æ —Å–ø—É—Ç–Ω–∏–∫–æ–º...";
        let s = [];
        let source = "–õ–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ—Ä–¥—ã";
        if(window.getScoresCloud) {
            const cs = await window.getScoresCloud();
            if(cs && cs.length > 0) { s = cs; source = "üèÜ –í—Å–µ–ª–µ–Ω–Ω–∞—è (–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥) üèÜ"; }
        }
        if(s.length===0) { s = JSON.parse(localStorage.getItem(LOCAL_KEY)||"[]"); source = "–õ–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ—Ä–¥—ã"; }
        s_txt.innerText = source;
        l.innerHTML = "";
        if(s.length===0) l.innerHTML = "<p>–ü—É—Å—Ç–æ! –°—ã–≥—Ä–∞–π –ø–µ—Ä–≤—ã–º.</p>";
        else {
            s.forEach((e,i) => {
                let m = i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":`#${i+1}`;
                l.innerHTML += `<li class="leaderboard-item"><span><span class="medal">${m}</span> ${e.name}</span><span class="score-num">${e.score}</span></li>`;
            });
        }
    }

    window.onload = function(){ 
        if(localStorage.getItem('moon_name')) document.getElementById('player-name').value = localStorage.getItem('moon_name');
    };

    const cvs = document.getElementById('gameCanvas');
    const ctx = cvs.getContext('2d');
    let W, H, st='MENU', sc=0, lives=3, startT=0, spawnT=0, combo=0, comboT=0, shake=0;
    let aliens=[], parts=[], texts=[];

    function resize(){ W=window.innerWidth; H=window.innerHeight; cvs.width=W; cvs.height=H; }
    window.addEventListener('resize', resize); resize();

    class Alien {
        constructor() {
            this.x=Math.random()*(W-100)+50; this.y=Math.random()*(H-200)+100;
            this.vx=(Math.random()-0.5)*2; this.vy=(Math.random()-0.5)*2;
            this.bad=Math.random()<0.25; this.t=Date.now(); this.s=0; this.st='up'; this.clk=false;
        }
        upd(speed, stay) {
            this.x+=this.vx*speed; this.y+=this.vy*speed;
            if(this.x<40||this.x>W-40)this.vx*=-1; if(this.y<80||this.y>H-80)this.vy*=-1;
            if(this.st==='up'){this.s+=0.1;if(this.s>=1)this.st='wait';}
            else if(this.st==='wait'){if(Date.now()-this.t>stay)this.st='down';}
            else if(this.st==='down'){this.s-=0.15;if(this.s<=0){this.st='dead'; if(!this.clk && !this.bad) loseLife();}}
        }
        drw() {
            if(this.st==='dead')return; ctx.save(); ctx.translate(this.x,this.y); ctx.scale(this.s,this.s);
            ctx.fillStyle='rgba(0,0,0,0.3)';ctx.beginPath();ctx.ellipse(0,50,40,15,0,0,Math.PI*2);ctx.fill();
            ctx.fillStyle=this.bad?'#94a3b8':'#88e064';if(this.bad)ctx.fillStyle='#cbd5e1';ctx.beginPath();ctx.arc(0,0,40,0,Math.PI*2);ctx.fill();
            ctx.fillStyle=this.bad?'#ef4444':'white';ctx.beginPath();ctx.arc(-15,-10,12,0,Math.PI*2);ctx.arc(15,-10,12,0,Math.PI*2);ctx.fill();
            ctx.fillStyle='black';ctx.beginPath();ctx.arc(-15,-10,5,0,Math.PI*2);ctx.arc(15,-10,5,0,Math.PI*2);ctx.fill();
            ctx.font="30px Arial";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(this.bad?"üíÄ":"‚ù§Ô∏è",0,20);ctx.restore();
        }
    }
    class Part {
        constructor(x,y,c){this.x=x;this.y=y;this.c=c;this.vx=(Math.random()-0.5)*15;this.vy=(Math.random()-0.5)*15;this.l=1;}
        upd(){this.x+=this.vx;this.y+=this.vy;this.vy+=0.5;this.l-=0.05;}
        drw(){ctx.globalAlpha=this.l;ctx.fillStyle=this.c;ctx.beginPath();ctx.arc(this.x,this.y,6,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;}
    }
    class Txt {
        constructor(x,y,t,c){this.x=x;this.y=y;this.t=t;this.c=c;this.l=1;}
        upd(){this.y-=2;this.l-=0.02;}
        drw(){ctx.globalAlpha=Math.max(0,this.l);ctx.fillStyle=this.c;ctx.font="bold 30px Arial";ctx.fillText(this.t,this.x,this.y);ctx.globalAlpha=1;}
    }

    function startGame(){
        const n=document.getElementById('player-name').value.trim();
        if(!n){document.getElementById('player-name').style.border="4px solid red"; return;}
        localStorage.setItem('moon_name', n);
        sc=0; lives=3; combo=0; startT=Date.now(); aliens=[]; parts=[]; texts=[];
        updLives(); document.getElementById('score-val').innerText=0;
        st='PLAYING'; showScreen(null); document.getElementById('game-ui').classList.remove('hidden');
    }
    function loseLife(){ if(st!=='PLAYING')return; lives--; updLives(); shake=15; const f=document.getElementById('damage-flash');f.style.opacity=0.5;setTimeout(()=>f.style.opacity=0,100); if(lives<=0)gameOver("–ñ–∏–∑–Ω–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å!"); }
    function updLives(){ document.getElementById('lives-container').innerText="‚ù§Ô∏è".repeat(lives)+"üñ§".repeat(3-lives); }
    async function gameOver(msg){
        st='GAMEOVER'; shake=20; document.getElementById('final-score').innerText=sc;
        document.getElementById('game-over-msg').innerText=msg; document.getElementById('game-ui').classList.add('hidden');
        const name=document.getElementById('player-name').value||"–ê–Ω–æ–Ω";
        const rec = await saveScore(name, sc);
        document.getElementById('new-record-msg').className = rec ? "" : "hidden";
        showScreen('game-over-screen');
    }
    function showScreen(id){document.querySelectorAll('.screen').forEach(e=>e.classList.add('hidden')); if(id)document.getElementById(id).classList.remove('hidden');}
    
    // --- –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï ---
    function handleInput(e) {
        if (st !== 'PLAYING') return;
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–≤–æ–π–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è –∏ –∑—É–º
        if(e.cancelable) e.preventDefault();

        const r = cvs.getBoundingClientRect();
        let clientX, clientY;

        if(e.changedTouches) {
            clientX = e.changedTouches[0].clientX;
            clientY = e.changedTouches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }

        const x = clientX - r.left;
        const y = clientY - r.top;

        for(let i=aliens.length-1;i>=0;i--){
            const a=aliens[i]; 
            // 90px —Ä–∞–¥–∏—É—Å –¥–ª—è –ø–∞–ª—å—Ü–µ–≤
            if(Math.sqrt((x-a.x)**2+(y-a.y)**2)<90 && a.s>0.3 && a.st!=='dead'){
                if(a.bad){ for(let j=0;j<10;j++)parts.push(new Part(a.x,a.y,'#ef4444')); gameOver("–°–∫–µ–ª–µ—Ç!"); }
                else {
                    a.clk=true; a.st='dead'; for(let j=0;j<10;j++)parts.push(new Part(a.x,a.y,'#fcd34d'));
                    const now=Date.now(); if(now-comboT<1200)combo++; else combo=1; comboT=now;
                    const p=10*combo; sc+=p; document.getElementById('score-val').innerText=sc;
                    texts.push(new Txt(a.x,a.y,`+${p}`, '#fcd34d'));
                    if(combo>1){ const cd=document.getElementById('combo-display'); cd.innerText=`x${combo}!`; cd.style.opacity=1; setTimeout(()=>cd.style.opacity=0,1000);}
                }
                break;
            }
        }
    }

    cvs.addEventListener('mousedown', handleInput);
    cvs.addEventListener('touchstart', handleInput, {passive: false});

    // --- AI FUNCTIONS ---
    async function nextQuizQuestion(){
        showScreen('quiz-screen'); 
        document.getElementById('quiz-question').innerText = "";
        document.getElementById('quiz-options').innerHTML = "";
        document.getElementById('quiz-feedback').innerText = "";
        
        document.getElementById('quiz-loading').classList.remove('hidden'); 
        document.getElementById('quiz-content').classList.add('hidden');
        document.getElementById('btn-next-quiz').classList.add('hidden');

        const t = await callGemini("–ü—Ä–∏–¥—É–º–∞–π –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–æ—Å–º–æ—Å –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞ 10 –ª–µ—Ç. –§–æ—Ä–º–∞—Ç: –í–æ–ø—Ä–æ—Å|||–û—Ç–≤–µ—Ç1|||–û—Ç–≤–µ—Ç2|||–û—Ç–≤–µ—Ç3|||–ò–Ω–¥–µ–∫—Å(1-3)");
        
        if(t.startsWith("–û–¢–õ–ê–î–ö–ê") || t.startsWith("–û—à–∏–±–∫–∞")) {
             document.getElementById('quiz-question').innerText=t; 
             document.getElementById('quiz-loading').classList.add('hidden'); 
             document.getElementById('quiz-content').classList.remove('hidden');
             return;
        }

        const p = t.split('|||');
        if(p.length>=5){
            document.getElementById('quiz-question').innerText=p[0]; 
            [1,2,3].forEach((ix)=>{
                const b=document.createElement('button'); b.className='btn btn-option'; b.innerText=p[ix]; 
                b.onclick=()=>checkQuiz(ix, parseInt(p[4]), b); document.getElementById('quiz-options').appendChild(b);
            });
            document.getElementById('quiz-loading').classList.add('hidden'); document.getElementById('quiz-content').classList.remove('hidden');
        } else {
             document.getElementById('quiz-question').innerText=t; 
             document.getElementById('quiz-loading').classList.add('hidden'); 
             document.getElementById('quiz-content').classList.remove('hidden');
             document.getElementById('btn-next-quiz').classList.remove('hidden');
        }
    }
    function checkQuiz(i,c,b){ 
        const f=document.getElementById('quiz-feedback');
        document.querySelectorAll('.btn-option').forEach(btn => btn.disabled = true);
        if(i===c){ f.innerText="–í–µ—Ä–Ω–æ! üéâ";f.style.color="#4ade80"; for(let k=0;k<5;k++) parts.push(new Part(W/2, H/2, 'gold')); }
        else{ b.style.background="#ef4444";f.innerText="–ù–µ —Å–æ–≤—Å–µ–º. –ü–æ–ø—Ä–æ–±—É–π –¥–∞–ª—å—à–µ!"; f.style.color="#ef4444"; } 
        document.getElementById('btn-next-quiz').classList.remove('hidden'); 
    }
    async function generateRiddle(){ const b=document.getElementById('riddle-box'); b.innerText="..."; const t=await callGemini("–ó–∞–≥–∞–¥–∫–∞ –ø—Ä–æ –∫–æ—Å–º–æ—Å. –§–æ—Ä–º–∞—Ç: –ó–∞–≥–∞–¥–∫–∞|||–û—Ç–≤–µ—Ç"); const p=t.split('|||'); if(p.length>=2)b.innerHTML=`<div>${p[0]}</div><div onclick="this.innerText='${p[1]}'" style="padding:10px;margin-top:5px;background:#333">***</div>`; else b.innerText=t; }
    
    // –ö–ê–§–ï
    async function orderFood(){ 
        const v=document.getElementById('cafe-order').value; 
        if(!v) return;
        document.getElementById('cafe-response').innerText = "–®–µ—Ñ-–ø–æ–≤–∞—Ä –≥–æ—Ç–æ–≤–∏—Ç...";
        const prompt = `–¢—ã –≤–µ—Å–µ–ª—ã–π –∏–Ω–æ–ø–ª–∞–Ω–µ—Ç–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä. –†–µ–±–µ–Ω–æ–∫ –∑–∞–∫–∞–∑–∞–ª: "${v}". –¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø—Ä–∏–¥—É–º–∞—Ç—å —ç—Ç–æ–º—É –±–ª—é–¥—É —Å–º–µ—à–Ω–æ–µ –ö–û–°–ú–ò–ß–ï–°–ö–û–ï –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –≤—Ä–æ–¥–µ "–ª—É–Ω–Ω–∞—è –ø—ã–ª—å", "–º–∞—Ä—Å–∏–∞–Ω—Å–∫–∏–π —Å–æ—É—Å", "–∂–∞—Ä–µ–Ω—ã–µ –º–µ—Ç–µ–æ—Ä–∏—Ç—ã". –°–¥–µ–ª–∞–π —ç—Ç–æ —Å–º–µ—à–Ω–æ –∏ –ø–æ-–¥–æ–±—Ä–æ–º—É. –¢–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ.`;
        document.getElementById('cafe-response').innerText = await callGemini(prompt);
    }

    function loop(t){
        let diff=0;
        if(st==='PLAYING'){
            diff=Math.min((Date.now()-startT)/35000, 1.0);
            document.getElementById('danger-bar').style.width=(diff*100)+'%';
            if(t>spawnT){aliens.push(new Alien()); spawnT=t+(1200-850*diff);}
        }
        let sx=0,sy=0; if(shake>0){sx=(Math.random()-0.5)*shake;sy=(Math.random()-0.5)*shake;shake*=0.9;}
        ctx.setTransform(1,0,0,1,sx,sy);
        ctx.fillStyle='#0b0d17'; ctx.fillRect(0,0,W,H);
        ctx.fillStyle='white'; for(let i=0;i<50;i++)ctx.fillRect((Math.sin(i*9)*W+W+t/20)%W, (Math.cos(i*5)*H+H)%H, Math.random()*2, Math.random()*2);
        ctx.fillStyle='#e2e8f0'; ctx.beginPath();ctx.ellipse(W/2,H+350,W,450,0,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#cbd5e1'; ctx.beginPath();ctx.ellipse(W/2-100,H-50,60,20,0,0,Math.PI*2);ctx.fill(); ctx.beginPath();ctx.ellipse(W/2+150,H-20,80,30,0,0,Math.PI*2);ctx.fill();

        if(st==='PLAYING'){
            aliens.forEach(a=>a.upd(1+3*diff, 2000-1400*diff)); aliens.forEach(a=>a.drw()); aliens=aliens.filter(a=>a.st!=='dead');
            parts.forEach(p=>{p.upd();p.drw()}); parts=parts.filter(p=>p.l>0);
            texts.forEach(x=>{x.upd();x.drw()}); texts=texts.filter(x=>x.l>0);
        } else if(st==='MENU'){
            ctx.font="60px Arial"; ctx.fillText("üõ∏", (t/4)%(W+200)-100, H-80+Math.sin(t/200)*5);
        }
        ctx.setTransform(1,0,0,1,0,0); requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
</script>
</body>
</html>
